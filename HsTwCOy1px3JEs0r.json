{
  "active": true,
  "connections": {
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent1": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "es mandado por el cliente",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mapear mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribir audio": {
      "main": [
        [
          {
            "node": "Mapear mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mapear mensaje": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File": {
      "main": [
        [
          {
            "node": "Transcribir audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obter m dia em base64": {
      "main": [
        [
          {
            "node": "Convert to File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "es mandado por el cliente": {
      "main": [
        [
          {
            "node": "Obter m dia em base64",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Redis3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "pregunta_usuario",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "pregunta_usuario": {
      "main": [
        [
          {
            "node": "Redis4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [],
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create an event in Google Calendar": {
      "ai_tool": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Delete an event in Google Calendar": {
      "ai_tool": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get many events in Google Calendar": {
      "ai_tool": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Send a message in Gmail": {
      "ai_tool": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "AI Agent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "Enviar texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis3": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis4": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Vector Store": {
      "ai_tool": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-11-16T08:31:13.148Z",
  "id": "HsTwCOy1px3JEs0r",
  "isArchived": false,
  "meta": null,
  "name": "chatbot abogados",
  "nodes": [
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "04868508-eb27-4b67-9dae-c883d48466d4",
              "name": "chat_id",
              "value": "={{ $json.body.data.key.remoteJid }}",
              "type": "string"
            },
            {
              "id": "48144532-1f21-4490-93e4-f6eeb2dfaa40",
              "name": "instance_name",
              "value": "={{ $json.body.instance }}",
              "type": "string"
            },
            {
              "id": "4073cc89-9702-4346-b6c2-7e619ee6f55d",
              "name": "api_key",
              "value": "[REDACTED]",
              "type": "string"
            },
            {
              "id": "a78a3578-e487-4dc4-bdc0-6e35e3df7013",
              "name": "url_server",
              "value": "={{ $json.body.server_url }}",
              "type": "string"
            },
            {
              "id": "005d7505-414e-42d0-ba75-390a2718043a",
              "name": "textoMensaje",
              "value": "={{ $json.body.data.message.conversation }}",
              "type": "string"
            },
            {
              "id": "b283725a-b70b-4324-8441-b5c1622e5e55",
              "name": "sessionKey",
              "value": "={{ $json.body.data.key.remoteJid }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        16,
        176
      ],
      "id": "7beeed07-f9c3-4bcc-ab2f-09efc6728c31",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Redis4').item.json.response }}",
        "options": {
          "systemMessage": "=# System Prompt - Asistente Virtual Despacho de Abogados Lex & Justicia\n\nEres un asistente profesional de atenci√≥n al cliente por WhatsApp para el **Despacho de Abogados Lex & Justicia**, ubicado en Madrid. Tu comunicaci√≥n debe ser cordial, clara, resolutiva y adaptada al canal de mensajer√≠a instant√°nea, siempre respetando la confidencialidad y seriedad que requiere el √°mbito legal.\n\nResponde de forma natural y directa, manteniendo siempre un tono amable, profesional y emp√°tico. Tu objetivo es ayudar al cliente, resolver dudas r√°pidamente, ofrecer informaci√≥n precisa sobre servicios legales y, cuando sea necesario, agendar consultas o derivar casos urgentes.\n\n---\n\n## üèõÔ∏è Nombre del despacho:\n**Despacho de Abogados Lex & Justicia**\n\n---\n\n## üìç Ubicaci√≥n:\n**Calle Mayor, 42, Madrid, Espa√±a**  \nCerca de la Plaza Mayor, a 5 minutos del metro √ìpera.  \nParking p√∫blico a 3 minutos caminando.\n\n---\n\n## üïò Horario de atenci√≥n:  \nLunes a viernes de 9:00h a 19:00h  \nS√°bados de 10:00h a 14:00h  \nDomingos cerrado\n\n---\n\n## üìû Contacto:\nTel√©fono: 913 45 26 61  \nWhatsApp: 642 11 22 33  \nEmail: contacto@lexyjusticia.com\n\n---\n\n## ‚öñÔ∏è Servicios principales y tarifas:\n\n### 1. Consultas legales\n- **Consulta inicial presencial u online**: 50‚Ç¨ - 80‚Ç¨ (30-60 minutos)\n- **Consulta telef√≥nica breve**: 30‚Ç¨ (15 minutos)\n\n### 2. Derecho Civil\n\n**Divorcios:**\n- Divorcio de mutuo acuerdo (express): 400‚Ç¨ - 600‚Ç¨\n- Divorcio contencioso: 1.200‚Ç¨ - 2.500‚Ç¨\n- Modificaci√≥n de medidas: 500‚Ç¨ - 900‚Ç¨\n\n**Herencias:**\n- Tramitaci√≥n de herencia simple: 800‚Ç¨ - 1.500‚Ç¨\n- Herencia con conflicto: 1.500‚Ç¨ - 3.500‚Ç¨\n- Redacci√≥n de testamento: 150‚Ç¨ - 300‚Ç¨\n\n**Contratos:**\n- Revisi√≥n de contrato: 150‚Ç¨ - 300‚Ç¨\n- Redacci√≥n de contrato personalizado: 250‚Ç¨ - 600‚Ç¨\n- Negociaci√≥n contractual: 400‚Ç¨ - 1.000‚Ç¨\n\n**Reclamaciones de cantidad:**\n- Juicio monitorio: 300‚Ç¨ - 600‚Ç¨\n- Reclamaci√≥n judicial: 500‚Ç¨ - 1.500‚Ç¨\n\n### 3. Derecho Penal\n\n- **Asistencia al detenido (urgente)**: 400‚Ç¨ - 800‚Ç¨\n- **Defensa en juicio r√°pido**: 600‚Ç¨ - 1.200‚Ç¨\n- **Defensa penal (delito leve)**: 1.000‚Ç¨ - 2.500‚Ç¨\n- **Defensa penal (delito grave)**: 2.500‚Ç¨ - 6.000‚Ç¨\n- **Recurso de apelaci√≥n penal**: 800‚Ç¨ - 1.800‚Ç¨\n\n### 4. Derecho Laboral\n\n- **Despido improcedente**: 600‚Ç¨ - 1.200‚Ç¨ (m√°s % de indemnizaci√≥n)\n- **Reclamaci√≥n de cantidad (n√≥minas, finiquito)**: 400‚Ç¨ - 900‚Ç¨\n- **ERE (Expediente de Regulaci√≥n de Empleo)**: 800‚Ç¨ - 1.800‚Ç¨\n- **Incapacidad laboral**: 700‚Ç¨ - 1.500‚Ç¨\n- **Modificaci√≥n sustancial de condiciones**: 500‚Ç¨ - 1.000‚Ç¨\n\n### 5. Derecho Inmobiliario\n\n- **Contrato de alquiler (redacci√≥n)**: 200‚Ç¨ - 400‚Ç¨\n- **Contrato de arras**: 250‚Ç¨ - 500‚Ç¨\n- **Compraventa de inmueble**: 600‚Ç¨ - 1.200‚Ç¨\n- **Desahucio por impago**: 600‚Ç¨ - 1.200‚Ç¨\n- **Reclamaci√≥n de fianza**: 300‚Ç¨ - 600‚Ç¨\n\n### 6. Derecho Mercantil\n\n- **Constituci√≥n de sociedad (SL o SA)**: 800‚Ç¨ - 1.500‚Ç¨\n- **Modificaci√≥n estatutos sociales**: 400‚Ç¨ - 800‚Ç¨\n- **Asesor√≠a empresarial mensual**: 200‚Ç¨ - 500‚Ç¨/mes\n- **Disoluci√≥n de sociedad**: 700‚Ç¨ - 1.400‚Ç¨\n- **Conflictos entre socios**: 1.000‚Ç¨ - 2.500‚Ç¨\n\n### 7. Mediaci√≥n y resoluci√≥n de conflictos\n\n- **Sesi√≥n de mediaci√≥n (por sesi√≥n)**: 150‚Ç¨ - 300‚Ç¨\n- **Proceso de mediaci√≥n completo**: 600‚Ç¨ - 1.500‚Ç¨\n\n### 8. Redacci√≥n de documentos legales personalizados\n\n- **Reclamaci√≥n extrajudicial (burofax)**: 80‚Ç¨ - 150‚Ç¨\n- **Demanda judicial**: 300‚Ç¨ - 800‚Ç¨\n- **Recurso administrativo**: 250‚Ç¨ - 600‚Ç¨\n- **Alegaciones**: 150‚Ç¨ - 400‚Ç¨\n- **Escritos judiciales**: 100‚Ç¨ - 300‚Ç¨\n\n---\n\n## üí∞ M√©todos de pago:\n\n**Formas de pago aceptadas:**\n- Efectivo\n- Tarjetas de cr√©dito y d√©bito\n- Transferencia bancaria\n- Bizum\n- **Financiaci√≥n en cuotas mensuales sin intereses** (casos superiores a 500‚Ç¨, hasta 12 meses)\n\n---\n\n## üö® Atenci√≥n a casos urgentes:\n\n- Atenci√≥n de urgencias legales durante el horario laboral\n- **Guardias 24 horas** para urgencias penales (asistencia al detenido)\n- N√∫mero de emergencias penales 24h: +34 666 789 012\n- Los casos urgentes se priorizan y se asignan al abogado m√°s adecuado\n\n---\n\n## üìÖ Pol√≠tica de citas:\n\n- **Todas las consultas requieren cita previa**\n- Recordatorios autom√°ticos por WhatsApp y email 24h y 2h antes de la cita\n- Cancelaciones con m√≠nimo 24 horas de antelaci√≥n\n- Reprogramaciones por tel√©fono o WhatsApp\n\n---\n\n## üîí Pol√≠tica de privacidad:\n\nLos datos personales se utilizan √∫nicamente para fines administrativos, legales y de contacto.  \nSe cumple estrictamente con la normativa europea GDPR.  \nLa informaci√≥n del cliente se guarda de forma segura y no se comparte sin autorizaci√≥n expresa.\n\n---\n\n## üìã Proceso para agendar una cita:\n\n### Paso 1: Identificar la necesidad\nPregunta al cliente sobre el √°rea legal de su consulta para asignar al abogado especializado:\n- \"¬øEn qu√© √°rea legal necesitas asesoramiento? Por ejemplo: divorcio, herencia, despido, penal, contratos, etc.\"\n\n### Paso 2: Preguntar fecha y hora preferida\n- \"¬øPara qu√© d√≠a y hora te gustar√≠a agendar tu consulta?\"\n\n### Paso 3: Confirmar disponibilidad\n- Indica que hay disponibilidad y que necesitas algunos datos para continuar.\n\n### Paso 4: Solicitar datos uno por uno\n\nPide los datos **uno por uno** y **espera respuesta tras cada uno**:\n\n1. \"Perfecto, para agendar tu consulta, ¬øme puedes indicar tu **nombre completo**, por favor?\"\n   *(Esperar respuesta)*\n\n2. \"Gracias, ¬øme das ahora tu **n√∫mero de tel√©fono**?\"\n   *(Esperar respuesta)*\n   > ‚ö†Ô∏è No es necesario pedir el prefijo +34, se asume por defecto.\n\n3. \"Y por √∫ltimo, ¬øtu **correo electr√≥nico**?\"\n   *(Esperar respuesta)*\n   > üìå Si el cliente no tiene o no quiere dar email, contin√∫a sin √©l.\n\n4. \"¬øPrefieres la consulta **presencial** en nuestro despacho o **online** por videollamada?\"\n   *(Esperar respuesta)*\n\n### Paso 5: Agendar la cita\n\nUtiliza la herramienta de agendamiento con los datos recopilados.\n\n- Si **no se pudo reservar**, informa del error amablemente y ofrece alternativas:\n  > \"Lo siento, ese horario no est√° disponible. ¬øTe vendr√≠a bien el [fecha alternativa] a las [hora]?\"\n\n- Si **la reserva fue exitosa**, contin√∫a al paso 6.\n\n### Paso 6: Confirmaci√≥n\n\nConfirma la cita con todos los detalles:\n\n> \"‚úÖ **Consulta agendada con √©xito**\n> \n> üìÖ Fecha: [D√çA/MES/A√ëO]  \n> üïê Hora: [HORA]  \n> üìç Modalidad: [Presencial/Online]  \n> ‚öñÔ∏è √Årea: [Derecho Civil/Penal/etc.]\n> \n> Recibir√°s recordatorios autom√°ticos 24h y 2h antes de tu cita.  \n> Si necesitas cancelar o reprogramar, av√≠sanos con al menos 24 horas de antelaci√≥n.\n> \n> ¬øNecesitas algo m√°s?\"\n\n- Si **no necesita nada m√°s**, desp√≠dete cordialmente:\n  > \"Perfecto, te esperamos. Si tienes cualquier duda antes de la consulta, no dudes en escribirnos. ¬°Que tengas un buen d√≠a!\"\n\n- Si **necesita algo m√°s**, responde usando la base de conocimientos.\n- En el caso de que te dio su email mandale un aviso de su cita por email usando esta tool 'Send a message in Gmail'\n---\n\n## üí° Preguntas frecuentes a manejar:\n\n**P: ¬øLa primera consulta es gratuita?**  \nR: No, la primera consulta informativa tiene un coste de 50‚Ç¨ a 80‚Ç¨ seg√∫n el √°rea legal (30-60 minutos).\n\n**P: ¬øCu√°nto cuesta un divorcio?**  \nR: Un divorcio de mutuo acuerdo tiene un precio desde 400‚Ç¨. Los divorcios contenciosos van desde 1.200‚Ç¨ hasta 2.500‚Ç¨ seg√∫n la complejidad.\n\n**P: ¬øCu√°nto cobran por un despido?**  \nR: La defensa en un despido improcedente tiene un coste de 600‚Ç¨ a 1.200‚Ç¨, m√°s un porcentaje sobre la indemnizaci√≥n obtenida.\n\n**P: ¬øAtienden a empresas?**  \nR: S√≠, atendemos tanto a empresas como a particulares. Ofrecemos asesor√≠a empresarial mensual desde 200‚Ç¨/mes.\n\n**P: ¬øHacen consultas online?**  \nR: S√≠, ofrecemos asistencia jur√≠dica online por videollamada para clientes dentro y fuera de Madrid.\n\n**P: ¬øTienen disponibilidad inmediata?**  \nR: Para casos urgentes, tenemos disponibilidad durante el horario laboral. Para urgencias penales contamos con guardias 24 horas.\n\n**P: ¬øOfrecen financiaci√≥n?**  \nR: S√≠, ofrecemos financiaci√≥n sin intereses en cuotas mensuales para casos superiores a 500‚Ç¨ (hasta 12 meses).\n\n---\n\n## üéØ Tono y estilo de comunicaci√≥n:\n\n- **Emp√°tico y cercano**, pero siempre profesional\n- **Confidencial**: nunca solicites detalles sensibles del caso por WhatsApp\n- **Claro y conciso**: mensajes breves adaptados a WhatsApp\n- **Resolutivo**: busca siempre ofrecer una soluci√≥n o siguiente paso\n- **Sin emojis excesivos**: usa solo los necesarios para humanizar (‚úÖüìÖüïêüìç‚öñÔ∏è)\n\n---\n\n## ‚ö†Ô∏è Importante:\n\n- **No des asesoramiento legal espec√≠fico** por WhatsApp. Para consultas legales concretas, agenda una cita con el abogado.\n- **No solicites detalles sensibles del caso** por este canal. Solo informaci√≥n b√°sica para el agendamiento.\n- **Mant√©n la confidencialidad** en todo momento.\n- Si el cliente tiene una urgencia penal seria (detenido), facilita el n√∫mero de emergencia del despacho: +34 666 789 012\n- **Los precios son orientativos** y pueden variar seg√∫n la complejidad del caso. Siempre menciona \"desde\" cuando des rangos de precio.\n\n---\n\n**Fecha de hoy:** {{ $json.fechaActual }}\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        2832,
        160
      ],
      "id": "3e46e1ee-edb9-42d7-a3a6-cdb51f61d65a",
      "name": "AI Agent1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook').item.json.body.data.message.audioMessage.mimetype }}",
                    "rightValue": "=audio/ogg; codecs=opus",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "be9dbcd5-0882-4ce9-9822-305865fae492"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6a0ec742-7f93-4ea1-af39-35d410da1c1a",
                    "leftValue": "={{ $('Webhook').item.json.body.data.messageType }}",
                    "rightValue": "conversation",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Texto"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        448,
        192
      ],
      "id": "b9679456-0fae-41ca-8454-564c5c6ca6fd",
      "name": "Switch"
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "aimaspain.contacto@gmail.com",
          "mode": "list",
          "cachedResultName": "aimaspain.contacto@gmail.com"
        },
        "start": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Start', ``, 'string') }}",
        "end": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('End', ``, 'string') }}",
        "additionalFields": {
          "description": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Description', ``, 'string') }}",
          "sendUpdates": "all",
          "summary": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Summary', ``, 'string') }}"
        }
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        2976,
        896
      ],
      "id": "aa2de244-7620-48ee-a794-2452ecc5e286",
      "name": "Crear evento",
      "credentials": {}
    },
    {
      "parameters": {
        "operation": "update",
        "calendar": {
          "__rl": true,
          "value": "aimaspain.contacto@gmail.com",
          "mode": "list",
          "cachedResultName": "aimaspain.contacto@gmail.com"
        },
        "eventId": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Event_ID', ``, 'string') }}",
        "updateFields": {}
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        3088,
        896
      ],
      "id": "6efbbdfd-eb98-4612-ae0a-d118e790a407",
      "name": "Actualizar evento",
      "credentials": {}
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "aimaspain.contacto@gmail.com",
          "mode": "list",
          "cachedResultName": "aimaspain.contacto@gmail.com"
        },
        "returnAll": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Return_All', ``, 'boolean') }}",
        "timeMin": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('After', ``, 'string') }}",
        "timeMax": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Before', ``, 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        3232,
        896
      ],
      "id": "95fad24d-146c-4f48-8d83-5c2237f5d640",
      "name": "Comprobar disponibilidad",
      "credentials": {}
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {
          "language": "es"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        624,
        -48
      ],
      "id": "da14452c-47cd-43b1-9d8a-ccba78987142",
      "name": "Transcribir audio",
      "credentials": {},
      "notes": "los audios estan en espa√±ol"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "defa1545-074d-4d6a-a21f-a95c2226995f",
              "name": "mensajeAudioOTexto",
              "value": "={{ $json.text || $('Webhook').item.json.body.data.message.conversation}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        704,
        192
      ],
      "id": "6da52562-e759-4db3-835d-d6b4ee2e5abe",
      "name": "Mapear mensaje"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Mapear mensaje').item.json.mensajeAudioOTexto }}",
                    "rightValue": "[null]",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    },
                    "id": "ea1ce058-1302-4e81-9680-f70a12960a82"
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        1136,
        176
      ],
      "id": "542101d3-b25d-4ace-8eb9-6fe84cfe2690",
      "name": "Switch1"
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "data.base64",
        "options": {
          "mimeType": "audio/mp3"
        }
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        384,
        -48
      ],
      "id": "bbe4b7d7-c2c7-444b-bdd1-02fa64170989",
      "name": "Convert to File"
    },
    {
      "parameters": {
        "resource": "chat-api",
        "operation": "get-media-base64",
        "instanceName": "demo whatsap",
        "messageId": "={{ $('Webhook').item.json.body.data.key.id }}"
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        48,
        -48
      ],
      "id": "ea0b2f41-160f-4ab0-b514-e0cc9467ec01",
      "name": "Obter m dia em base64",
      "credentials": {}
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Edit Fields').item.json.sessionKey }}",
        "tableName": "n8n_chat_histories_abogados"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        2720,
        592
      ],
      "id": "3e14671f-97c5-4a2a-9be9-f46a0cf73400",
      "name": "Postgres Chat Memory",
      "credentials": {}
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolDescription": "aqui sacas info sobre los servicios, ubicacion y otros datos.",
        "tableName": {
          "__rl": true,
          "value": "documents",
          "mode": "list",
          "cachedResultName": "documents"
        },
        "topK": 50,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        2736,
        768
      ],
      "id": "8b65ef26-fb13-46ca-a249-f6b8e28f1927",
      "name": "Supabase Vector Store",
      "credentials": {}
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        2656,
        896
      ],
      "id": "7a6547c1-a79f-42ac-b9f7-d937b47aaaa6",
      "name": "Embeddings OpenAI",
      "credentials": {}
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        2608,
        416
      ],
      "id": "92229a8e-176e-44b3-831b-f821555afa24",
      "name": "OpenAI Chat Model",
      "credentials": {}
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook').item.json.body.data.key.fromMe.toString() }}",
                    "rightValue": "=false",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "84f1ac15-47a9-4f36-b8b0-73ea0edc3ecc"
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -160,
        -48
      ],
      "id": "411cbff7-b1c4-4527-a21d-3a4dc7e687e6",
      "name": "es mandado por el cliente"
    },
    {
      "parameters": {
        "amount": 7
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        1568,
        176
      ],
      "id": "f9404301-d658-4403-96c9-48d33ac10b1a",
      "name": "Wait",
      "webhookId": "REDACTED"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "8ac5729a-0f8a-4564-b4f9-dd5e1fcb4c05",
              "leftValue": "={{ $json.message.last() }}",
              "rightValue": "={{ $('Mapear mensaje').item.json.mensajeAudioOTexto }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1984,
        176
      ],
      "id": "be0b0a9d-3be6-4dea-b309-96c186cfb9c0",
      "name": "If"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2288,
        480
      ],
      "id": "8ae68db5-5d58-4e05-bdd7-16a50592d921",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4a46e63b-2ead-4f35-aaa2-ab4ef5fc69f2",
              "name": "response",
              "value": "={{ $('Redis3').item.json.message }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2272,
        160
      ],
      "id": "994c9852-11df-4210-9079-6d929dd6e8e9",
      "name": "pregunta_usuario"
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Utiliza esta herramienta para eliminar eventos del calendario.",
        "operation": "delete",
        "calendar": {
          "__rl": true,
          "value": "aimaspain.contacto@gmail.com",
          "mode": "list",
          "cachedResultName": "aimaspain.contacto@gmail.com"
        },
        "eventId": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Event_ID', ``, 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        2848,
        896
      ],
      "id": "f45ba23c-c3fd-497a-b232-de9b0a85ffee",
      "name": "Eliminar evento",
      "credentials": {}
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "641c492a-2026-49ba-81d8-31d19976fd99",
              "leftValue": "={{ $json.body.data.key.fromMe.toString() }}",
              "rightValue": "false",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -384,
        192
      ],
      "id": "13e8daf2-1d0e-4dd9-9ca3-3c8110c42785",
      "name": "If1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "62cf7f96-e1f3-4350-850c-548e2291ed79",
              "leftValue": "={{ $('Webhook').item.json.body.data.key.remoteJid }}",
              "rightValue": "34641750559@s.whatsapp.net",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        912,
        176
      ],
      "id": "ee7401fb-4b5b-45fd-8ff3-6eaa55157c73",
      "name": "If2"
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "aimaspain.contacto@gmail.com",
          "mode": "list",
          "cachedResultName": "aimaspain.contacto@gmail.com"
        },
        "start": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Start', ``, 'string') }}",
        "end": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('End', ``, 'string') }}",
        "useDefaultReminders": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Use_Default_Reminders', ``, 'boolean') }}",
        "additionalFields": {
          "attendees": [
            "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('attendees0_Attendees', ``, 'string') }}",
            "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('attendees1_Attendees', ``, 'string') }}"
          ],
          "description": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Description', ``, 'string') }}"
        }
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        3376,
        592
      ],
      "id": "c0dbbfe3-8522-4286-a3bf-03a61e332776",
      "name": "Create an event in Google Calendar",
      "credentials": {}
    },
    {
      "parameters": {
        "operation": "delete",
        "calendar": {
          "__rl": true,
          "value": "aimaspain.contacto@gmail.com",
          "mode": "list",
          "cachedResultName": "aimaspain.contacto@gmail.com"
        },
        "eventId": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Event_ID', ``, 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        3232,
        592
      ],
      "id": "97518eb3-53da-43e7-8946-5d362107c5b1",
      "name": "Delete an event in Google Calendar",
      "credentials": {}
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "aimaspain.contacto@gmail.com",
          "mode": "list",
          "cachedResultName": "aimaspain.contacto@gmail.com"
        },
        "returnAll": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Return_All', ``, 'boolean') }}",
        "timeMin": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('After', ``, 'string') }}",
        "timeMax": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Before', ``, 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        3088,
        592
      ],
      "id": "677ff477-c7c9-45a1-a6ff-46439523a57e",
      "name": "Get many events in Google Calendar",
      "credentials": {}
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "demo whatsap",
        "remoteJid": "={{ $json.chat_id }}",
        "messageText": "={{ $('AI Agent1').item.json.output }}",
        "options_message": {
          "delay": 1000
        }
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        3568,
        160
      ],
      "id": "6f76027b-3c15-473f-b7d7-e430947214ff",
      "name": "Enviar texto",
      "credentials": {}
    },
    {
      "parameters": {
        "sendTo": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('To', ``, 'string') }}",
        "subject": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Subject', ``, 'string') }}",
        "emailType": "text",
        "message": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Message', ``, 'string') }}",
        "options": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.gmailTool",
      "typeVersion": 2.1,
      "position": [
        2928,
        592
      ],
      "id": "f2d9cd52-e943-484d-b3fe-ad791681f14d",
      "name": "Send a message in Gmail",
      "webhookId": "REDACTED",
      "credentials": {}
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "abogados",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -544,
        192
      ],
      "id": "645de25c-9285-4604-840f-50ab8be423ad",
      "name": "Webhook",
      "webhookId": "REDACTED"
    },
    {
      "parameters": {
        "jsCode": "// Obtener fecha actual en zona horaria de Madrid\nconst ahora = new Date();\n\n// Convertir a zona horaria de Madrid (Europe/Madrid)\nconst fechaMadrid = new Date(ahora.toLocaleString('en-US', { timeZone: 'Europe/Madrid' }));\n\n// Arrays en espa√±ol\nconst diasSemana = ['domingo', 'lunes', 'martes', 'mi√©rcoles', 'jueves', 'viernes', 's√°bado'];\nconst meses = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', \n               'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];\n\n// Extraer componentes de la fecha en Madrid\nconst diaSemana = diasSemana[fechaMadrid.getDay()];\nconst dia = fechaMadrid.getDate();\nconst mes = meses[fechaMadrid.getMonth()];\nconst anio = fechaMadrid.getFullYear();\nconst hora = String(fechaMadrid.getHours()).padStart(2, '0');\nconst minutos = String(fechaMadrid.getMinutes()).padStart(2, '0');\n\n// Construir la fecha en formato espa√±ol completo\nconst fechaActual = diaSemana + ' ' + dia + ' de ' + mes + ' de ' + anio + ', ' + hora + ':' + minutos;\n\n// Retornar el resultado\nreturn {\n  fechaActual: fechaActual\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2608,
        160
      ],
      "id": "7cc15548-5c2f-4d73-898d-53e7cade3245",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "jsCode": "let remoteJid = $('Edit Fields').first().json.chat_id;\n\nlet newValue;\nif (remoteJid === '237412974375033@lid') {\n  newValue = '56971357546@s.whatsapp.net';\n} else {\n  newValue = remoteJid;\n}\n\nreturn [{\n  json: {\n    chat_id: newValue\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3312,
        160
      ],
      "id": "22441fee-1e52-4351-aa3b-e468974e2d2d",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Edit Fields').item.json.chat_id }}",
        "messageData": "={{ $json.mensajeAudioOTexto }}",
        "tail": true
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1344,
        176
      ],
      "id": "e77c2725-2e6d-43a2-9912-4733805ab9b5",
      "name": "Redis",
      "credentials": {}
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "message",
        "key": "={{ $('Edit Fields').item.json.chat_id }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1776,
        176
      ],
      "id": "3e4ef966-5326-4014-b310-7e48a38ba143",
      "name": "Redis3",
      "credentials": {}
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Edit Fields').item.json.chat_id }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2464,
        160
      ],
      "id": "195e12dd-fbd7-484c-bfef-e1f8b6b8db84",
      "name": "Redis4",
      "credentials": {}
    }
  ],
  "origin": "n8n",
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "personal-n8n.rk9l1c.easypanel.host",
            "user-agent": "axios/1.7.9",
            "content-length": "921",
            "accept-encoding": "gzip, compress, deflate, br",
            "content-type": "application/json",
            "x-forwarded-for": "172.18.0.1",
            "x-forwarded-host": "personal-n8n.rk9l1c.easypanel.host",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "227e2e43f3cd",
            "x-real-ip": "172.18.0.1"
          },
          "params": {},
          "query": {},
          "body": {
            "event": "messages.upsert",
            "instance": "demo whatsap",
            "data": {
              "key": {
                "remoteJid": "34612575083@s.whatsapp.net",
                "fromMe": false,
                "id": "AC7809B3C2177EA5BE8CAB39EBDDC3FB"
              },
              "pushName": "Abde",
              "status": "DELIVERY_ACK",
              "message": {
                "conversation": "Despacho",
                "messageContextInfo": {
                  "deviceListMetadata": {
                    "senderKeyHash": "GPmaWMlSK9/Z0Q==",
                    "senderTimestamp": "1761991188",
                    "recipientKeyHash": "DR2kVJHVntzmTQ==",
                    "recipientTimestamp": "1762884883"
                  },
                  "deviceListMetadataVersion": 2,
                  "messageSecret": "4tmsPtvGUuTQolilb/r0QOpnpKwlo/JL0DIyTn4thKI="
                }
              },
              "messageType": "conversation",
              "messageTimestamp": 1763287060,
              "instanceId": "2a0d9865-759f-4e6b-8e42-4ccaa9fd2d56",
              "source": "android"
            },
            "destination": "https://personal-n8n.rk9l1c.easypanel.host/webhook/abogados",
            "date_time": "2025-11-16T06:57:40.461Z",
            "sender": "34641750559@s.whatsapp.net",
            "server_url": "https://personal-evolution-api.rk9l1c.easypanel.host",
            "apikey": "341DA03A8BB5-4F67-9135-BECA8A83EC55"
          },
          "webhookUrl": "https://personal-n8n.rk9l1c.easypanel.host/webhook/abogados",
          "executionMode": "production"
        }
      }
    ]
  },
  "repo": {
    "owner": "abdeidr",
    "name": "n8n"
  },
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "createdAt": "2025-11-16T08:31:13.157Z",
      "updatedAt": "2025-11-16T08:31:13.157Z",
      "role": "workflow:owner",
      "workflowId": "HsTwCOy1px3JEs0r",
      "projectId": "xdZYvePgLSibegaD"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-11-16T10:00:23.000Z",
  "versionId": "318b89a3-9d20-4a72-8d12-a07e317d835b"
}