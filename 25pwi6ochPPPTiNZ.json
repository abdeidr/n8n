{
  "active": false,
  "connections": {
    "Obtener Lead": {
      "main": [
        [
          {
            "node": "Lead Existe?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lead Existe?": {
      "main": [
        [
          {
            "node": "Obtener Historial Completo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Crear Lead Nuevo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Lead Nuevo": {
      "main": [
        [
          {
            "node": "Obtener Historial Completo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Historial Completo": {
      "main": [
        [
          {
            "node": "AI Agent - Calificador",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI - Calificaci√≥n": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent - Calificador",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Tool - Add Score Points": {
      "ai_tool": [
        [
          {
            "node": "AI Agent - Calificador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Tool - Update Lead Data": {
      "ai_tool": [
        [
          {
            "node": "AI Agent - Calificador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "Obtener Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent - Calificador",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent - Calificador": {
      "main": [
        [
          {
            "node": "Update rows in a table",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "mandar aviso por whatsap": {
      "ai_tool": [
        [
          {
            "node": "AI Agent - Calificador",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-10-13T14:01:20.738Z",
  "id": "25pwi6ochPPPTiNZ",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "AI Agent - Calificaci√≥n Leads Osteopat√≠a subworkflow",
  "nodes": [
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT *\nFROM leads\nWHERE telefono = '{{ $json.Chat_Id }}';\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        -992,
        112
      ],
      "id": "266dd3f6-9b28-4cb0-8058-a9b118648e77",
      "name": "Obtener Lead",
      "retryOnFail": true,
      "credentials": {}
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.id }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -784,
        112
      ],
      "id": "2b6420be-32d7-45a7-94b9-dae63647a889",
      "name": "Lead Existe?"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "value": "public",
          "mode": "list"
        },
        "table": {
          "__rl": true,
          "value": "leads",
          "mode": "list"
        },
        "dataMode": "defineBelow",
        "valuesToSend": {
          "values": [
            {
              "column": "telefono",
              "value": "={{ $('When Executed by Another Workflow').item.json.Chat_Id }}"
            },
            {
              "column": "mensaje_inicial",
              "value": "={{ $('When Executed by Another Workflow').item.json.Mensaje_actual }}"
            },
            {
              "column": "conversation_stage",
              "value": "0"
            },
            {
              "column": "score",
              "value": "0"
            },
            {
              "column": "nombre",
              "value": "nombre"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        -544,
        272
      ],
      "id": "d8918f64-5ba5-4362-b293-67d559da6905",
      "name": "Crear Lead Nuevo",
      "credentials": {}
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT *\nFROM leads\nWHERE telefono = '{{ $('When Executed by Another Workflow').item.json.Chat_Id }}';\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        -336,
        96
      ],
      "id": "a897f58f-7de2-48d3-91e3-e920e294f800",
      "name": "Obtener Historial Completo",
      "credentials": {}
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "gpt-4o"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -208,
        384
      ],
      "id": "57f4f52a-19b9-4093-8844-479039280ab5",
      "name": "OpenAI - Calificaci√≥n",
      "credentials": {}
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Analiza el historial de conversaci√≥n y califica este lead.\n\n\n\n**√öLTIMO MENSAJE:**\n{{ $('When Executed by Another Workflow').item.json.Mensaje_actual }}\n\n**RESPUESTA DEL AGENTE:**\n{{ $('When Executed by Another Workflow').item.json.respuesta_agente }}\n\n**DATOS ACTUALES DEL LEAD:**\n```\nScore: {{ $('Obtener Lead').item.json.score || 0 }}\nStage: {{ $('Obtener Lead').item.json.conversation_stage || 0 }}\nProblema: {{ $('Obtener Lead').item.json.problema_principal || 'No identificado' }}\nUrgencia: {{ $('Obtener Lead').item.json.urgencia || 'No evaluada' }}\n```\nnombre:{{ $json.nombre }}\n\nEjecuta las acciones de calificaci√≥n seg√∫n el System Prompt.",
        "options": {
          "systemMessage": "=# AGENTE DE CALIFICACI√ìN - PROGRAMA INTENSIVO OSTEOPAT√çA\n\n## üéØ TU ROL\nEres un sistema experto en **calificaci√≥n autom√°tica de leads** para el Programa Intensivo Integral. Trabajas en silencio (nunca hablas con el usuario) y tu misi√≥n es:\n1. Analizar el historial completo de conversaci√≥n\n2. Asignar puntuaci√≥n seg√∫n urgencia, intenci√≥n y ubicaci√≥n\n3. Clasificar leads (CALIENTE/TIBIO/FR√çO)\n4. Actualizar base de datos y activar alertas al equipo\n\n***\n\n## üìä SISTEMA DE SCORING\n\n### 1Ô∏è‚É£ URGENCIA (Primera evaluaci√≥n)\n| Tiempo mencionado | Puntos | Clasificaci√≥n |\n|------------------|--------|---------------|\n| Horas, 1-7 d√≠as | +15 | agudo_urgente |\n| 1-4 semanas | +10 | agudo |\n| 1-3 meses | +7 | subagudo |\n| 3-12 meses | +5 | cronico_moderado |\n| M√°s de 1 a√±o | +3 | cronico |\n\n***\n\n### 2Ô∏è‚É£ UBICACI√ìN (Segunda evaluaci√≥n - CR√çTICA)\n| Ubicaci√≥n | Puntos | Viabilidad |\n|----------|--------|------------|\n| Madrid capital o zona metropolitana (Pozuelo, Majadahonda, Boadilla, Las Rozas, Aravaca, etc.) | +15 | viable_presencial |\n| Comunidad de Madrid (fuera √°rea metropolitana) con disposici√≥n a desplazarse | +10 | viable_con_esfuerzo |\n| Fuera de Madrid pero dispuesto a viajar peri√≥dicamente | +5 | viable_limitado |\n| Fuera de Madrid sin disposici√≥n a desplazarse | +0 | no_viable |\n\n***\n\n### 3Ô∏è‚É£ INTENCI√ìN (Tercera evaluaci√≥n)\n| Indicadores | Puntos | Intenci√≥n |\n|------------|--------|-----------|\n| \"Necesito soluci√≥n YA\", \"quiero empezar\", \"cu√°ndo puedo ir\" | +15 | compra_inmediata |\n| \"Estoy interesado\", \"quiero saber m√°s del programa\", \"cu√°nto cuesta\" | +10 | interes_alto |\n| \"Estoy comparando opciones\", \"quiero pensarlo\" | +5 | consideracion |\n| \"Solo informaci√≥n\", \"es para el futuro\", \"lo pensar√©\" | +0 | exploracion |\n\n***\n\n## üéØ CLASIFICACI√ìN FINAL\n\n### üî¥ **CALIENTE (Score ‚â• 30)**\n**Perfil:** Madrid + Urgencia alta + Intenci√≥n de compra inmediata\n\n**Acciones OBLIGATORIAS:**\n\n1. **`Tool - Update Lead Data`:**\n   - clasificacion = \"caliente\"\n   - necesita_llamada = false\n   - problema_principal = [extraer del historial]\n   - urgencia = [clasificaci√≥n de la tabla]\n   - ubicacion = [ciudad/zona mencionada]\n\n2. **`mandar aviso por whatsapp`:**\n   - Asunto: \"üî• LEAD CALIENTE - CONVERSI√ìN INMEDIATA\"\n   - Cuerpo:\n     ```\n     üî• LEAD CALIENTE - Acci√≥n Inmediata Requerida\n\n     üë§ Nombre: {{ $json.nombre }}\n     üìû Tel√©fono: {{ $json.telefono }}\n     \n     üìä DATOS CLAVE:\n     ‚Ä¢ Problema: [problema_principal]\n     ‚Ä¢ Tiempo: [urgencia]\n     ‚Ä¢ Ubicaci√≥n: [ciudad/zona]\n     ‚Ä¢ Score: [VALOR_CALCULADO]\n     \n     ‚è∞ Requiere seguimiento en las pr√≥ximas 2 horas\n     ```\n\n3. **`Tool - Add Score Points`:**\n   - score = [VALOR_CALCULADO]\n\n***\n\n### üü° **TIBIO (Score 15-29)**\n**Perfil:** Cumple 1-2 criterios (ej: Madrid pero sin urgencia, o urgencia pero necesita llamada aclaratoria)\n\n**Acciones OBLIGATORIAS:**\n\n1. **`Tool - Update Lead Data`:**\n   - clasificacion = \"tibio\"\n   - necesita_llamada = true\n   - problema_principal = [extraer del historial]\n   - urgencia = [clasificaci√≥n de la tabla]\n   - ubicacion = [ciudad/zona mencionada]\n\n2. **`mandar aviso por whatsapp`:**\n   - Asunto: \"üìû LEAD TIBIO - Llamada de Seguimiento\"\n   - Cuerpo:\n     ```\n     üìû LEAD TIBIO - Requiere Llamada Manual\n\n     üë§ Nombre: {{ $json.nombre }}\n     üìû Tel√©fono: {{ $json.telefono }}\n     \n     üìä DATOS CLAVE:\n     ‚Ä¢ Problema: [problema_principal]\n     ‚Ä¢ Tiempo: [urgencia]\n     ‚Ä¢ Ubicaci√≥n: [ciudad/zona]\n     ‚Ä¢ Score: [VALOR_CALCULADO]\n     \n     ‚ö†Ô∏è BARRERA DETECTADA: [ej: \"Sin urgencia declarada\" o \"Fuera de √°rea metropolitana\"]\n     \n     üí° ACCI√ìN: Llamar en las pr√≥ximas 24h para:\n     - Resolver dudas sobre el programa\n     - Explicar metodolog√≠a 360¬∫\n     - Agendar evaluaci√≥n inicial\n     ```\n\n3. **`Tool - Add Score Points`:**\n   - score = [VALOR_CALCULADO]\n\n***\n\n### üîµ **FR√çO (Score < 15)**\n**Perfil:** Fuera de Madrid sin viabilidad o solo busca informaci√≥n sin intenci√≥n\n\n**Acciones OBLIGATORIAS:**\n\n1. **`Tool - Update Lead Data`:**\n   - clasificacion = \"frio\"\n   - necesita_llamada = false\n   - problema_principal = [extraer del historial]\n   - urgencia = [clasificaci√≥n de la tabla]\n   - ubicacion = [ciudad/zona mencionada]\n\n2. **NO enviar aviso por WhatsApp** (no requiere seguimiento inmediato)\n\n3. **`Tool - Add Score Points`:**\n   - score = [VALOR_CALCULADO]\n\n***\n\n## üîç AN√ÅLISIS QUE DEBES HACER\n\n**Pasos obligatorios:**\n\n1. **Lee el historial completo** de la conversaci√≥n\n2. **Extrae los 4 datos clave:**\n   - ‚úÖ Problema espec√≠fico (ej: \"hernia L4-L5\", \"ci√°tica\", \"dolor cervical\")\n   - ‚úÖ Tiempo de evoluci√≥n (ej: \"2 a√±os\", \"3 semanas\")\n   - ‚úÖ Ubicaci√≥n geogr√°fica (ej: \"Pozuelo\", \"Madrid centro\", \"Sevilla\")\n   - ‚úÖ Intenci√≥n de compra (ej: \"quiero empezar ya\", \"solo informaci√≥n\")\n3. **Calcula score total** sumando puntos de las 3 tablas\n4. **Clasifica seg√∫n rangos** (CALIENTE ‚â•30, TIBIO 15-29, FR√çO <15)\n5. **Ejecuta tools correspondientes** seg√∫n clasificaci√≥n\n\n***\n\n## ‚öôÔ∏è TOOLS DISPONIBLES\n\n- **`Tool - Add Score Points`** ‚Üí Sumar puntos (acumulativo)\n- **`Tool - Update Lead Data`** ‚Üí Actualizar todos los campos (clasificacion,necesita_llamada, problema_principal, urgencia)\n- **`mandar aviso por whatsapp`** ‚Üí Alertas al equipo (solo CALIENTE y TIBIO)\n**Asegurate de usar las tools cuando sea necesario.\n***\n\n## ‚úÖ REGLAS DE ORO\n\n1. **Silencioso:** NUNCA generas mensajes para el usuario\n2. **Preciso:** Solo usas los puntos especificados en las tablas\n3. **Completo:** Siempre actualizas clasificacion + necesita_llamada + problema_principal + urgencia + ubicacion\n4. **Selectivo:** Solo env√≠as avisos para CALIENTE y TIBIO (NO para FR√çO)\n5. **Acumulativo:** Usa `Add Score Points` con el valor total calculado\n6. **Geogr√°fico:** La ubicaci√≥n es CR√çTICA - sin Madrid/alrededores, m√°ximo TIBIO\n\n***\n\n## üö´ NO HAGAS\n\n- ‚ùå Enviar mensajes de WhatsApp al usuario (eso es del Agente Conversacional)\n- ‚ùå Inventar puntuaciones fuera de las tablas\n- ‚ùå Clasificar sin analizar el historial completo\n- ‚ùå Enviar avisos al equipo para leads FR√çOS\n- ‚ùå Clasificar como CALIENTE si no est√° en Madrid/√°rea metropolitana\n\n***\n\n## üéØ OBJETIVO\n\nProcesar el lead en segundo plano mientras el usuario recibe respuestas del Agente Conversacional. Tu trabajo es **invisible pero cr√≠tico**: determinas qu√© leads reciben seguimiento inmediato del equipo humano.\n\n***\n\n## üìã EJEMPLO DE AN√ÅLISIS\n\n**Historial:**\n- Usuario: \"Me duele la espalda baja desde hace 2 a√±os\"\n- Usuario: \"Vivo en Pozuelo\"\n- Usuario: \"Necesito soluci√≥n ya, no aguanto m√°s\"\n\n**An√°lisis del Agente:**\n- Urgencia: +3 (cronico - m√°s de 1 a√±o)\n- Ubicaci√≥n: +15 (Pozuelo = zona metropolitana)\n- Intenci√≥n: +15 (compra inmediata)\n- **Score Total: 33**\n- **Clasificaci√≥n: CALIENTE**\n\n**Acciones ejecutadas:**\n1. Update Lead Data: clasificacion=\"caliente\", necesita_llamada=false, problema_principal=\"dolor lumbar cronico\", urgencia=\"cronico\", ubicacion=\"Pozuelo\"\n2. Aviso WhatsApp al equipo: \"üî• LEAD CALIENTE - Score 33\"\n3. Add Score Points: 33\n\n***"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -96,
        80
      ],
      "id": "caa330d5-4140-40af-9c46-69a8a25446aa",
      "name": "AI Agent - Calificador"
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "leads",
          "mode": "list"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "score": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('score', `modif√≠calo al el nuevo score calculado`, 'number') }}",
            "telefono": "={{ $json.telefono }}"
          },
          "matchingColumns": [
            "telefono"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "nombre",
              "displayName": "nombre",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "telefono",
              "displayName": "telefono",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "mensaje_inicial",
              "displayName": "mensaje_inicial",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "clasificacion",
              "displayName": "clasificacion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "problema_principal",
              "displayName": "problema_principal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "intentos_contacto",
              "displayName": "intentos_contacto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "ultima_interaccion",
              "displayName": "ultima_interaccion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "ultimo_mensaje",
              "displayName": "ultimo_mensaje",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "necesita_llamada",
              "displayName": "necesita_llamada",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "conversation_stage",
              "displayName": "conversation_stage",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "score",
              "displayName": "score",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "urgencia",
              "displayName": "urgencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Pago_Es_Enviado",
              "displayName": "Pago_Es_Enviado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        336,
        560
      ],
      "id": "19b6655b-6fa8-4b06-a637-dd95bed5a02b",
      "name": "Tool - Add Score Points",
      "credentials": {}
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "leads",
          "mode": "list"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "clasificacion": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('clasificacion', ``, 'string') }}",
            "problema_principal": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('problema_principal', ``, 'string') }}",
            "urgencia": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('urgencia', ``, 'string') }}",
            "necesita_llamada": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('necesita_llamada', ``, 'boolean') }}",
            "intentos_contacto": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('intentos_contacto', ``, 'number') }}",
            "telefono": "={{ $json.telefono }}",
            "nombre": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('nombre', ``, 'string') }}",
            "mensaje_inicial": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('mensaje_inicial', ``, 'string') }}",
            "email": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('email', ``, 'string') }}"
          },
          "matchingColumns": [
            "telefono"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "nombre",
              "displayName": "nombre",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "telefono",
              "displayName": "telefono",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "mensaje_inicial",
              "displayName": "mensaje_inicial",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "clasificacion",
              "displayName": "clasificacion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "problema_principal",
              "displayName": "problema_principal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "intentos_contacto",
              "displayName": "intentos_contacto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ultima_interaccion",
              "displayName": "ultima_interaccion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "ultimo_mensaje",
              "displayName": "ultimo_mensaje",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "necesita_llamada",
              "displayName": "necesita_llamada",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "conversation_stage",
              "displayName": "conversation_stage",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "score",
              "displayName": "score",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "urgencia",
              "displayName": "urgencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Pago_Es_Enviado",
              "displayName": "Pago_Es_Enviado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "pdf_secuencia",
              "displayName": "pdf_secuencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "fecha_ultimo_pdf",
              "displayName": "fecha_ultimo_pdf",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "respondio_pdf",
              "displayName": "respondio_pdf",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "fecha_ultmensaje_resp",
              "displayName": "fecha_ultmensaje_resp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "conversation_id",
              "displayName": "conversation_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        496,
        560
      ],
      "id": "4cb4566f-6774-4b8c-9f75-d738cb5e78f3",
      "name": "Tool - Update Lead Data",
      "credentials": {}
    },
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "Mensaje_actual"
            },
            {
              "name": "Chat_Id"
            },
            {
              "name": "nombre"
            },
            {
              "name": "respuesta_agente"
            }
          ]
        }
      },
      "id": "4b2f5e57-0d34-46ec-85b8-fab8f5f3a9dc",
      "typeVersion": 1.1,
      "name": "When Executed by Another Workflow",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "position": [
        -1232,
        112
      ]
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('When Executed by Another Workflow').item.json.Chat_Id }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        -64,
        384
      ],
      "id": "e1fa0878-d7ae-44f6-963f-c78adb54b1dc",
      "name": "Postgres Chat Memory",
      "credentials": {}
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "leads",
          "mode": "list",
          "cachedResultName": "leads"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telefono": "={{ $('When Executed by Another Workflow').item.json.Chat_Id }}",
            "ultima_interaccion": "={{ $now }}",
            "ultimo_mensaje": "={{ $('When Executed by Another Workflow').item.json.Mensaje_actual }}",
            "fecha_ultmensaje_resp": "={{ $now }}"
          },
          "matchingColumns": [
            "telefono"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "nombre",
              "displayName": "nombre",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "telefono",
              "displayName": "telefono",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "mensaje_inicial",
              "displayName": "mensaje_inicial",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "clasificacion",
              "displayName": "clasificacion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "problema_principal",
              "displayName": "problema_principal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "intentos_contacto",
              "displayName": "intentos_contacto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "ultima_interaccion",
              "displayName": "ultima_interaccion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "ultimo_mensaje",
              "displayName": "ultimo_mensaje",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "necesita_llamada",
              "displayName": "necesita_llamada",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "conversation_stage",
              "displayName": "conversation_stage",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "score",
              "displayName": "score",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "urgencia",
              "displayName": "urgencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Pago_Es_Enviado",
              "displayName": "Pago_Es_Enviado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "pdf_secuencia",
              "displayName": "pdf_secuencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "fecha_ultimo_pdf",
              "displayName": "fecha_ultimo_pdf",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "respondio_pdf",
              "displayName": "respondio_pdf",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "fecha_ultmensaje_resp",
              "displayName": "fecha_ultmensaje_resp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        256,
        80
      ],
      "id": "50b1b8f4-6008-4a09-9f9a-d9ddadd38f73",
      "name": "Update rows in a table",
      "retryOnFail": true,
      "credentials": {}
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://personal-evolution-api.rk9l1c.easypanel.host/message/sendText/demo whatsap",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "[REDACTED]"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "number",
              "value": "34662119065@s.whatsapp.net"
            },
            {
              "name": "text",
              "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('parameters1_Value', ``, 'string') }}"
            },
            {
              "name": "delay",
              "value": "={{1000}}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        672,
        544
      ],
      "id": "725f8bd7-f78c-4d5b-bc31-24cbf8a46965",
      "name": "mandar aviso por whatsap"
    }
  ],
  "origin": "n8n",
  "pinData": {
    "When Executed by Another Workflow": [
      {
        "json": {
          "Mensaje_actual": "Tengo dolor lumbar",
          "Chat_Id": "+34612575083",
          "nombre": "Abde",
          "respuesta_agente": "¬°Hola! üëã Bienvenido/a al Centro Osteop√°tico Atlas.\n\nNuestra cl√≠nica se enfoca en un abordaje 360¬∫ para patolog√≠as cr√≥nico-degenerativas, integrando fisioterapia, osteopat√≠a y naturopat√≠a.\n\nPara evaluar brevemente tu caso y verificar si nuestro Programa Intensivo est√° indicado para ti, necesito que me contestes estas dos preguntas clave:\n\n¬øDesde cu√°ndo tienes el dolor lumbar? (d√≠as, semanas, meses, a√±os)"
        }
      }
    ]
  },
  "repo": {
    "owner": "abdeidr",
    "name": "n8n"
  },
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "createdAt": "2025-10-13T14:01:20.744Z",
      "updatedAt": "2025-10-13T14:01:20.744Z",
      "role": "workflow:owner",
      "workflowId": "25pwi6ochPPPTiNZ",
      "projectId": "xdZYvePgLSibegaD"
    }
  ],
  "staticData": null,
  "tags": [
    {
      "createdAt": "2025-11-12T22:09:07.928Z",
      "updatedAt": "2025-11-12T22:09:07.928Z",
      "id": "N5H00c4tU3rtlPMX",
      "name": "CentroAtlas"
    }
  ],
  "triggerCount": 0,
  "updatedAt": "2025-11-21T18:06:12.000Z",
  "versionId": "7a7292dd-3f09-405a-aad1-022486ade52a"
}