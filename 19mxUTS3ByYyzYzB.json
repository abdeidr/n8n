{
  "active": true,
  "connections": {
    "Postgres - Obtener Lead y Historial": {
      "main": [
        [
          {
            "node": "IF - Lead no es Nuevo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres - Crear Lead Nuevo": {
      "main": [
        [
          {
            "node": "Execute a SQL query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory1": {
      "ai_memory": [
        [
          {
            "node": "AI Agent - Conversacional",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Tool - Update Lead Stage": {
      "ai_tool": [
        [
          {
            "node": "AI Agent - Conversacional",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "update_lead_data": {
      "ai_tool": [
        []
      ]
    },
    "Tool - Send Alert Email": {
      "ai_tool": [
        []
      ]
    },
    "IF - Lead no es Nuevo": {
      "main": [
        [
          {
            "node": "Execute a SQL query",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Postgres - Crear Lead Nuevo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Select rows from a table in Postgres": {
      "ai_tool": [
        []
      ]
    },
    "Execute a SQL query": {
      "main": [
        [
          {
            "node": "AI Agent - Conversacional",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent - Conversacional",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent - Conversacional": {
      "main": [
        [
          {
            "node": "Mandar mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call 'WORKFLOW 2 - Agente de Calificaci√≥n'": {
      "main": [
        []
      ]
    },
    "Supabase Vector Store": {
      "ai_tool": [
        [
          {
            "node": "AI Agent - Conversacional",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Tool - cambiar nombre": {
      "ai_tool": [
        [
          {
            "node": "AI Agent - Conversacional",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Tool - Update Pago_Es_Enviado": {
      "ai_tool": [
        [
          {
            "node": "AI Agent - Conversacional",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Download media",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mapear mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribir audio": {
      "main": [
        [
          {
            "node": "Mapear mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mapear mensaje": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Redis1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis1": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "pregunta_usuario",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "pregunta_usuario": {
      "main": [
        [
          {
            "node": "Redis2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [],
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "Switch2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis2": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Postgres - Obtener Lead y Historial",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download media": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Transcribir audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch2": {
      "main": [
        [
          {
            "node": "Switch3",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Mandar mensaje": {
      "main": [
        [
          {
            "node": "Call 'WORKFLOW 2 - Agente de Calificaci√≥n'",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch3": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent - Conversacional",
            "type": "ai_languageModel",
            "index": 1
          }
        ]
      ]
    }
  },
  "createdAt": "2025-10-09T15:12:09.084Z",
  "id": "19mxUTS3ByYyzYzB",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "Agente conversacional Atlas",
  "nodes": [
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  COUNT(*) as total\nFROM leads\nWHERE telefono = '{{ $('Edit Fields1').item.json.chat_id }}';\n",
        "options": {}
      },
      "id": "837053aa-5e85-43db-bdaf-bd9c20f4d271",
      "name": "Postgres - Obtener Lead y Historial",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        1088,
        1392
      ],
      "credentials": {}
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "value": "public",
          "mode": "list",
          "cachedResultName": "public"
        },
        "table": {
          "__rl": true,
          "value": "leads",
          "mode": "list",
          "cachedResultName": "leads"
        },
        "dataMode": "defineBelow",
        "valuesToSend": {
          "values": [
            {
              "column": "nombre",
              "value": "={{ $('Edit Fields1').item.json.user_name }}"
            },
            {
              "column": "telefono",
              "value": "={{ $('Edit Fields1').item.json.chat_id }}"
            },
            {
              "column": "mensaje_inicial",
              "value": "={{ $('Mapear mensaje').item.json.mensajeAudioOTexto }}"
            },
            {
              "column": "conversation_stage",
              "value": "0"
            },
            {
              "column": "score",
              "value": "0"
            },
            {
              "column": "clasificacion",
              "value": "Fr√≠o"
            }
          ]
        },
        "options": {}
      },
      "id": "22691fb1-44d3-4c8e-ba43-e09f94ebd496",
      "name": "Postgres - Crear Lead Nuevo",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        1456,
        1584
      ],
      "executeOnce": false,
      "alwaysOutputData": true,
      "credentials": {}
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Edit Fields1').item.json.chat_id }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        1632,
        1968
      ],
      "id": "f5c41d1c-0889-4c2e-830d-afe68876e06c",
      "name": "Postgres Chat Memory1",
      "credentials": {}
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "leads",
          "mode": "list",
          "cachedResultName": "leads"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "conversation_stage": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('conversation_stage', ``, 'number') }}",
            "telefono": "={{ $('Edit Fields1').item.json.chat_id }}"
          },
          "matchingColumns": [
            "telefono"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "nombre",
              "displayName": "nombre",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "telefono",
              "displayName": "telefono",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "mensaje_inicial",
              "displayName": "mensaje_inicial",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "clasificacion",
              "displayName": "clasificacion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "problema_principal",
              "displayName": "problema_principal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "intentos_contacto",
              "displayName": "intentos_contacto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "ultima_interaccion",
              "displayName": "ultima_interaccion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "ultimo_mensaje",
              "displayName": "ultimo_mensaje",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "necesita_llamada",
              "displayName": "necesita_llamada",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "conversation_stage",
              "displayName": "conversation_stage",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "score",
              "displayName": "score",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "urgencia",
              "displayName": "urgencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Pago_Es_Enviado",
              "displayName": "Pago_Es_Enviado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "pdf_secuencia",
              "displayName": "pdf_secuencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "fecha_ultimo_pdf",
              "displayName": "fecha_ultimo_pdf",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "respondio_pdf",
              "displayName": "respondio_pdf",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        1920,
        1984
      ],
      "id": "1617382b-835f-4edb-ba03-eabde5fab80d",
      "name": "Tool - Update Lead Stage",
      "credentials": {}
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "leads",
          "mode": "list",
          "cachedResultName": "leads"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "necesita_llamada": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('necesita_llamada', ``, 'boolean') }}",
            "id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('id__using_to_match_', ``, 'number') }}",
            "intentos_contacto": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('intentos_contacto', ``, 'number') }}",
            "conversation_stage": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('conversation_stage', ``, 'number') }}",
            "nombre": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('nombre', ``, 'string') }}",
            "telefono": "={{ $('Webhook').item.json.body.data.key.remoteJid }}",
            "email": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('email', ``, 'string') }}",
            "mensaje_inicial": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('mensaje_inicial', ``, 'string') }}",
            "fuente": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fuente', ``, 'string') }}",
            "estado": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('estado', ``, 'string') }}",
            "clasificacion": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('clasificacion', ``, 'string') }}",
            "razon_clasificacion": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('razon_clasificacion', ``, 'string') }}",
            "problema_principal": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('problema_principal', ``, 'string') }}",
            "ultima_interaccion": "={{ $now }}",
            "ultimo_mensaje": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('ultimo_mensaje', ``, 'string') }}",
            "created_at": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('created_at', ``, 'string') }}",
            "updated_at": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('updated_at', ``, 'string') }}",
            "score": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('score', ``, 'number') }}",
            "urgencia": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('urgencia', ``, 'string') }}"
          },
          "matchingColumns": [
            "telefono"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "nombre",
              "displayName": "nombre",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telefono",
              "displayName": "telefono",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "mensaje_inicial",
              "displayName": "mensaje_inicial",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "fuente",
              "displayName": "fuente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "fecha_captacion",
              "displayName": "fecha_captacion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "estado",
              "displayName": "estado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "clasificacion",
              "displayName": "clasificacion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "razon_clasificacion",
              "displayName": "razon_clasificacion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "problema_principal",
              "displayName": "problema_principal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "intentos_contacto",
              "displayName": "intentos_contacto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "ultima_interaccion",
              "displayName": "ultima_interaccion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "ultimo_mensaje",
              "displayName": "ultimo_mensaje",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "necesita_llamada",
              "displayName": "necesita_llamada",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "conversation_stage",
              "displayName": "conversation_stage",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "score",
              "displayName": "score",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "urgencia",
              "displayName": "urgencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2272,
        2000
      ],
      "id": "682a988a-bbd6-47fb-94b9-ffd0c6c29355",
      "name": "update_lead_data",
      "credentials": {}
    },
    {
      "parameters": {
        "sendTo": "idrabde0@gmail.com",
        "subject": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Subject', ``, 'string') }}",
        "message": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Message', ``, 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.gmailTool",
      "typeVersion": 2.1,
      "position": [
        1936,
        1952
      ],
      "id": "63a4e4bf-e98b-46d6-8641-6e998f571de6",
      "name": "Tool - Send Alert Email",
      "webhookId": "REDACTED",
      "credentials": {}
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.total }}",
              "operation": "larger"
            }
          ]
        }
      },
      "id": "1c247b7c-0bef-41e8-8856-690b1d09fa0d",
      "name": "IF - Lead no es Nuevo",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1280,
        1392
      ]
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "leads",
          "mode": "list",
          "cachedResultName": "leads"
        },
        "returnAll": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Return_All', ``, 'boolean') }}",
        "where": {
          "values": [
            {
              "column": "telefono",
              "value": "={{ $('Webhook').item.json.body.data.key.remoteJid }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2352,
        2000
      ],
      "id": "96e4a06a-3cf7-4bba-b709-40a3efe8172d",
      "name": "Select rows from a table in Postgres",
      "credentials": {}
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT *\nFROM leads\nWHERE telefono = '{{ $('Edit Fields1').item.json.chat_id }}';\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1600,
        1376
      ],
      "id": "3b40528f-bebd-445b-9609-21b11751cec3",
      "name": "Execute a SQL query",
      "credentials": {}
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "gpt-4o"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1680,
        1600
      ],
      "id": "8419bd35-9695-48af-9154-02ae02f84f66",
      "name": "OpenAI Chat Model",
      "notesInFlow": false,
      "credentials": {}
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Redis2').item.json.response }}",
        "needsFallback": true,
        "options": {
          "systemMessage": "=# AGENTE DE CONVERSACI√ìN - OSTEOPAT√çA\n\n## üéØ TU ROL\nEres un asistente virtual emp√°tico y profesional de una cl√≠nica de osteopat√≠a. Tu √öNICA misi√≥n es:\n1. **Mantener una conversaci√≥n natural** con el paciente  \n2. **Recopilar informaci√≥n clave** de forma sutil (problema, tiempo, intenci√≥n)  \n3. **Responder preguntas usando la base de conocimiento** (horarios, precios, ubicaci√≥n)  \n4. **Continuar la conversaci√≥n** si el usuario pregunta algo m√°s  \n5. **NO tomas decisiones de calificaci√≥n** (eso lo hace otro agente)\n\n---\n\n## üìã INFORMACI√ìN DEL USUARIO\nNombre:\nTel√©fono: {{ $json.telefono }}\n\n---\n\n## üóÑÔ∏è BASE DE CONOCIMIENTO DISPONIBLE\n\n**Tienes acceso a informaci√≥n del centro mediante la herramienta `Supabase Vector Store`.**\n\nUsa esta tool cuando el usuario pregunte sobre:\n- üìç Ubicaci√≥n y direcci√≥n  \n- üïê Horarios de atenci√≥n  \n- üí∂ Precios y tarifas  \n- üè• Servicios disponibles  \n- üë®‚Äç‚öïÔ∏è Especialistas  \n- üìû Formas de contacto  \n- ‚ôø Accesibilidad  \n- üÖøÔ∏è Parking  \n- y mas cosas\n\n**IMPORTANTE:** Antes de inventar informaci√≥n, **SIEMPRE consulta primero** la base vectorial usando la tool `Supabase Vector Search` con la pregunta del usuario.\n\n---\n\n## üí¨ FLUJO DE CONVERSACI√ìN\n\n### 1Ô∏è‚É£ PRIMER CONTACTO\n¬°Hola! üëã Gracias por contactarnos.\n\nCu√©ntame, ¬øqu√© molestia o dolor te trae hoy?\n**Usa la tool 'Tool - Update Lead Stage' y cambia conversation_stage a 1.**\n\n\n### 2Ô∏è‚É£ IDENTIFICAR PROBLEMA\nEntiendo, [problema].\n\n¬øHace cu√°nto tiempo tienes esta molestia? (d√≠as, semanas, meses)\n**Usa la tool 'Tool - Update Lead Stage' y cambia conversation_stage a 2.**\n\n\n### 3Ô∏è‚É£ EVALUAR TIEMPO\nGracias por la informaci√≥n.\n\n¬øYa has considerado buscar una soluci√≥n profesional, o de momento solo buscas informaci√≥n?\n**Usa la tool 'Tool - Update Lead Stage' y cambia conversation_stage a 3.**\n\n### 4Ô∏è‚É£ Mandar enlace de pago a los clientes calientes\n\n¬°Excelente! Por la urgencia y el inter√©s que has mostrado, te recomiendo la Evaluaci√≥n Inicial en Promoci√≥n. Cuesta solo 45‚Ç¨ y te dar√° un diagn√≥stico preciso. Puedes reservar tu hora y pagar de forma segura aqu√≠:üëâ https://apposteopatiaatlas.viday.es/reserva\n**M√°nda el enlace as√≠ tal cual sin meter corchetes ni par√©ntesis**\nüìå Importante: Si despu√©s decides contratar uno de nuestros packs de tratamiento, descontaremos el precio de esta evaluaci√≥n inicial del total del programa.\n**mandale el mensaje entero con el enlace para que agende**\n**Usa la tool 'Tool - Update Lead Stage' y cambia conversation_stage a 4.**\n**Usa la tool 'Tool - Update Pago_Es_Enviado' y c√°mbialo a true.**\n\n---\n## üîÄ MANEJO DE INTERRUPCIONES EN EL FLUJO\n\n**‚ö†Ô∏è REGLA CR√çTICA: Si el usuario hace una pregunta DURANTE el proceso de recopilaci√≥n de los 3 datos clave (problema, tiempo, intenci√≥n), DEBES:**\n\n1. **PAUSA** el flujo actual\n2. **RESPONDE** su pregunta de forma breve (consultando `Supabase Vector Search` si es necesario)\n3. **RETOMA EXACTAMENTE** la √∫ltima pregunta pendiente del flujo de recopilaci√≥n\n4. **NO hagas preguntas nuevas** - solo retoma la pregunta que qued√≥ sin responder\n\n**‚úÖ IMPORTANTE:** Esta regla SOLO aplica durante conversation_stage 1, 2 o 3. \n\n**Una vez completada la recopilaci√≥n (stage 4 o superior), NO retomes el flujo de preguntas iniciales.**\n\n### üìù EJEMPLOS DE INTERRUPCI√ìN:\n\n**EJEMPLO 1 - Interrupci√≥n en Stage 2 (pregunta de tiempo):**\n\nT√∫: \"Entiendo, dolor de cabeza. ¬øHace cu√°nto tiempo tienes esta molestia?\"\n\nUsuario: \"¬øQu√© horario ten√©is?\"\n\n**‚úÖ RESPUESTA CORRECTA:**\nT√∫: [Consultas Supabase Vector Search: \"horarios de atenci√≥n\"]\n\"Nuestros horarios son de lunes a viernes de 9:00 a 20:00h y s√°bados de 10:00 a 14:00h.\n\nVolviendo a tu dolor de cabeza, ¬øhace cu√°nto tiempo tienes esta molestia?\"\n\n**‚ùå RESPUESTA INCORRECTA:**\n\"Nuestros horarios son... ¬øTienes preferencia de horario?\" ‚Üê NO hagas preguntas nuevas\n\n---\n\n**EJEMPLO 2 - Interrupci√≥n en Stage 3 (pregunta de intenci√≥n):**\n\nT√∫: \"Gracias por la informaci√≥n. ¬øYa has considerado buscar una soluci√≥n profesional, o de momento solo buscas informaci√≥n?\"\n\nUsuario: \"¬øCu√°nto cuesta?\"\n\n**‚úÖ RESPUESTA CORRECTA:**\nT√∫: Te comento los precios con total transparencia. Es importante que sepas que nuestros programas intensivos est√°n dise√±ados para ofrecerte un ahorro significativo comparado con si contrataras todos los servicios por separado.\n\nTe pongo primero los precios sueltos de cada servicio para que puedas ver la diferencia:\n\n**Precios de Servicios Sueltos (Sin Programa)**\n\n¬∑ Sesi√≥n de Osteopat√≠a: 80‚Ç¨\n¬∑ Sesi√≥n de Aparatolog√≠a de Fisioterapia: 35‚Ç¨\n¬∑ Sesi√≥n Inicial de Medicina Natural (Evaluaci√≥n): 110‚Ç¨\n¬∑ Seguimiento de Medicina Natural (sesi√≥n semanal): 70‚Ç¨\n\n---\n\n**El Ahorro Real con Nuestros Programas Intensivos**\n\nAhora, mira el valor y el ahorro que obtienes al contratar un programa completo:\n\n**1. Programa Intensivo de 1 Mes:**\n\n¬∑ Incluye: 5 sesiones de Osteopat√≠a + 5 Aparatolog√≠as.\n¬∑ Valor si lo pagaras suelto: (5 x 80‚Ç¨) + (5 x 35‚Ç¨) = 400‚Ç¨ + 175‚Ç¨ = 575‚Ç¨\n¬∑ Precio del Programa: 350‚Ç¨\n¬∑ ‚úÖ Tu Ahorro: 225‚Ç¨ (¬°Casi un 40% de descuento!)\n\n**2. Programa Intensivo Integral (2-4 meses) - ¬°El m√°s completo!**\n\n¬∑ Incluye: 10 sesiones de Osteopat√≠a + 10 Aparatolog√≠as + Evaluaci√≥n de Medicina Natural (110‚Ç¨) + 1 Sesi√≥n de Seguimiento (70‚Ç¨).\n¬∑ Valor si lo pagaras suelto:\n  ¬∑ Osteopat√≠a y Aparatolog√≠a: (10 x 80‚Ç¨) + (10 x 35‚Ç¨) = 800‚Ç¨ + 350‚Ç¨ = 1.150‚Ç¨\n  ¬∑ Medicina Natural: 110‚Ç¨ (inicial) + 70‚Ç¨ (seguimiento) = 180‚Ç¨\n  ¬∑ Valor Total Suelto: 1.330‚Ç¨\n¬∑ Precio del Programa: 700‚Ç¨\n¬∑ ‚úÖ Tu Ahorro: 630‚Ç¨ (¬°Casi un 50% de descuento!)\n\n**‚ö†Ô∏è IMPORTANTE:** Solo a√±ade la frase de retomar si a√∫n est√°s en conversation_stage 3 (NO has enviado el enlace de pago):\n\n\"Volviendo a tu caso, ¬øya has considerado buscar una soluci√≥n profesional o de momento solo buscas informaci√≥n?\"\n\n**Si ya enviaste el enlace (conversation_stage 4+), termina con:**\n\n\"¬øTe gustar√≠a agendar una evaluaci√≥n inicial para ver cu√°l programa se adapta mejor a ti?\"\n\n---\n\n**EJEMPLO 3 - Pregunta DESPU√âS de completar recopilaci√≥n (Stage 4+):**\n\nT√∫: [Ya enviaste el enlace de pago]\n\nUsuario: \"¬øQu√© horario ten√©is?\"\n\n**‚úÖ RESPUESTA CORRECTA:**\nT√∫: \"Nuestros horarios son de lunes a viernes de 9:00 a 20:00h y s√°bados de 10:00 a 14:00h. üòä\n\n¬øTe gustar√≠a confirmar algo m√°s sobre tu cita?\"\n\n**‚ùå RESPUESTA INCORRECTA:**\n\"Nuestros horarios son... Volviendo a tu caso, ¬øqu√© molestia te trae?\" ‚Üê NO retomes el flujo si ya lo completaste\n\n### üéØ RECORDATORIO CLAVE:\n**Hasta que no tengas los 3 datos (problema + tiempo + intenci√≥n), NO cambies el flujo. Siempre retoma la pregunta pendiente despu√©s de resolver la interrupci√≥n.**\n\n---\n\n## üîÄ MANEJO DE PREGUNTAS ADICIONALES\n\n### üìÖ **Horarios/Citas:**\n1. Consulta `Supabase Vector Store` con la query: \"horarios de atenci√≥n\"\n2. Responde:\nClaro, nuestros horarios son [info de la base de datos].\n\n¬øTienes preferencia de horario para tu consulta?\n\n### üí∂ **Precios:**\n1. Consulta `Supabase Vector Search` con la query: \"precios tratamientos osteopat√≠a\"\n2. Responde:\nTenemos las siguientes tarifas:\n[info de la base de datos]\n\n¬øTe gustar√≠a que un especialista te explique las opciones para tu [problema]?\n\n\n### üìç **Ubicaci√≥n:**\n1. Consulta `Supabase Vector Search` con la query: \"direcci√≥n ubicaci√≥n centro\"\n2. Responde:\nEstamos ubicados en [direcci√≥n de la base de datos].\n\n¬øNecesitas indicaciones para llegar o informaci√≥n sobre parking?\n\n\n### üÖøÔ∏è **Parking/Transporte:**\nConsulta `Supabase Vector Search` con la query: \"parking transporte p√∫blico acceso\"  \nResponde con la informaci√≥n obtenida.\n\n### üè• **Servicios/Tratamientos:**\nConsulta `Supabase Vector Search` con la query: \"[tipo de tratamiento espec√≠fico]\"  \nResponde:\nPara [problema del usuario], ofrecemos [servicios de la base de datos].\n\n¬øTe gustar√≠a m√°s detalles sobre alg√∫n tratamiento en particular?\n\n\n### üë®‚Äç‚öïÔ∏è **Especialistas:**\nConsulta `Supabase Vector Search` con la query: \"equipo oste√≥patas especialistas\"  \nResponde con la informaci√≥n correspondiente.\n\n### üéì **Programas Intensivos:**\nSi preguntan sobre los programas, responde:\n\nMuchas gracias por tu inter√©s. Te explico nuestros dos programas intensivos, dise√±ados para ofrecerte una soluci√≥n profunda y duradera a tu problema.\n\nAmbos programas combinan lo mejor de la terapia manual con la tecnolog√≠a m√°s avanzada para acelerar tu recuperaci√≥n.\n\n**1. PROGRAMA INTENSIVO DE 1 MES**\n\n¬∑ Duraci√≥n: Aproximadamente 1 mes.\n¬∑ Ideal para: Aliviar dolores agudos, recuperarte de una lesi√≥n reciente o dar un primer impulso intensivo a tu salud.\n¬∑ Incluye:\n  ¬∑ 5 sesiones de Osteopat√≠a: Para tratar la ra√≠z del problema mediante manipulaciones articulares, t√©cnicas musculares y trabajo fascial.\n  ¬∑ 5 sesiones de Aparatolog√≠a de Fisioterapia: Aplicaremos la tecnolog√≠a m√°s adecuada para tu caso (Magnetoterapia, Diatermia, Vacunterapia, Ondas de Choque, Punci√≥n Seca o Neuromodulaci√≥n).\n\n**2. PROGRAMA INTENSIVO INTEGRAL (2-4 MESES) - ¬°NUESTRO PROGRAMA M√ÅS COMPLETO!**\n\n¬∑ Duraci√≥n: Dise√±ado para durar entre 2 y 4 meses, adapt√°ndose a tu ritmo y evoluci√≥n.\n¬∑ Ideal para: Problemas cr√≥nicos, lesiones complejas o si buscas una transformaci√≥n profunda en tu salud con un enfoque 100% integral.\n¬∑ Incluye:\n  ¬∑ 10 sesiones de Osteopat√≠a + 10 sesiones de Aparatolog√≠a de Fisioterapia.\n  ¬∑ EVALUACI√ìN DE MEDICINA NATURAL (Diferencial exclusivo): Un valor a√±adido donde no solo tratamos la lesi√≥n, sino que optimizamos tu salud global. Incluye:\n    ¬∑ Un plan de dieta personalizado.\n    ¬∑ Recomendaciones de suplementaci√≥n espec√≠fica para reducir la inflamaci√≥n y ayudar a la regeneraci√≥n.\n    ¬∑ Seguimiento naturop√°tico durante todo el programa para asegurar los mejores resultados.\n\nLa Aparatolog√≠a que usamos (Magnetoterapia, Diatermia, Vacunterapia, Ondas de Choque, etc.) se selecciona en cada sesi√≥n seg√∫n tus necesidades para potenciar al m√°ximo los efectos de la osteopat√≠a.\n\nEl objetivo de ambos es que no solo te quites el dolor, sino que recuperes tu funcionalidad y calidad de vida con unos cimientos s√≥lidos.\n\n¬øTe gustar√≠a agendar una evaluaci√≥n inicial para que nuestro especialista valore tu caso y te recomiende el programa que mejor se adapte a ti? ¬°Estaremos encantados de ayudarte!\n\n### üí∞ **Precios de Programas Intensivos:**\nSi preguntan espec√≠ficamente por los precios de los programas, responde:\n\nTe comento los precios con total transparencia. Es importante que sepas que nuestros programas intensivos est√°n dise√±ados para ofrecerte un ahorro significativo comparado con si contrataras todos los servicios por separado.\n\nTe pongo primero los precios sueltos de cada servicio para que puedas ver la diferencia:\n\n**Precios de Servicios Sueltos (Sin Programa)**\n\n¬∑ Sesi√≥n de Osteopat√≠a: 80‚Ç¨\n¬∑ Sesi√≥n de Aparatolog√≠a de Fisioterapia: 35‚Ç¨\n¬∑ Sesi√≥n Inicial de Medicina Natural (Evaluaci√≥n): 110‚Ç¨\n¬∑ Seguimiento de Medicina Natural (sesi√≥n semanal): 70‚Ç¨\n\n---\n\n**El Ahorro Real con Nuestros Programas Intensivos**\n\nAhora, mira el valor y el ahorro que obtienes al contratar un programa completo:\n\n**1. Programa Intensivo de 1 Mes:**\n\n¬∑ Incluye: 5 sesiones de Osteopat√≠a + 5 Aparatolog√≠as.\n¬∑ Valor si lo pagaras suelto: (5 x 80‚Ç¨) + (5 x 35‚Ç¨) = 400‚Ç¨ + 175‚Ç¨ = 575‚Ç¨\n¬∑ Precio del Programa: 350‚Ç¨\n¬∑ ‚úÖ Tu Ahorro: 225‚Ç¨ (¬°Casi un 40% de descuento!)\n\n**2. Programa Intensivo Integral (2-4 meses) - ¬°El m√°s completo!**\n\n¬∑ Incluye: 10 sesiones de Osteopat√≠a + 10 Aparatolog√≠as + Evaluaci√≥n de Medicina Natural (110‚Ç¨) + 1 Sesi√≥n de Seguimiento (70‚Ç¨).\n¬∑ Valor si lo pagaras suelto:\n  ¬∑ Osteopat√≠a y Aparatolog√≠a: (10 x 80‚Ç¨) + (10 x 35‚Ç¨) = 800‚Ç¨ + 350‚Ç¨ = 1.150‚Ç¨\n  ¬∑ Medicina Natural: 110‚Ç¨ (inicial) + 70‚Ç¨ (seguimiento) = 180‚Ç¨\n  ¬∑ Valor Total Suelto: 1.330‚Ç¨\n¬∑ Precio del Programa: 700‚Ç¨\n¬∑ ‚úÖ Tu Ahorro: 630‚Ç¨ (¬°Casi un 50% de descuento!)\n\nEn resumen: Los programas no son solo un paquete de sesiones, son un camino estructurado hacia tu recuperaci√≥n con una inversi√≥n mucho m√°s ventajosa. Obtienes un tratamiento completo y coherente por mucho menos que si contrataras todo por separado.\n\n¬øTe gustar√≠a agendar una evaluaci√≥n inicial para ver cu√°l se adapta mejor a ti? Quedo a tu disposici√≥n.\n\n### ‚ùì **Dudas sobre el tratamiento:**\nEs normal tener dudas.\n\nPara tu caso espec√≠fico de [problema], lo mejor es que un oste√≥pata valore tu situaci√≥n. ¬øTe interesar√≠a una evaluaci√≥n inicial?\n\n\n### üîÑ **Si pide agendar directamente:**\n¬°Perfecto! Puedes reservar tu cita directamente aqu√≠:\nüëâ https://apposteopatiaatlas.viday.es/reserva\n**M√°nda el enlace as√≠ tal cual sin meter corchetes ni par√©ntesis**\n\nUna vez confirmada tu reserva, te llegar√° un mensaje con los detalles de tu cita. ¬øHay algo m√°s en lo que pueda ayudarte?\n\n\n### ü§∑ **Si no encuentras informaci√≥n en la base:**\nD√©jame consultar eso con el equipo.\n\nUn especialista te contactar√° pronto con esa informaci√≥n. Mientras tanto, ¬øhay algo m√°s en lo que pueda ayudarte?\n\n\n---\n\n## ‚úÖ REGLAS DE ORO\n\n### Comunicaci√≥n:\n- **Brevedad:** M√°ximo 3 l√≠neas por mensaje  \n- **Una pregunta a la vez**  \n- **Tono c√°lido pero profesional**  \n- **Usa emojis moderadamente** (1-2 por mensaje m√°ximo)\n\n### Uso de la Base de Conocimiento:\n- **SIEMPRE consulta** `Supabase Vector Search` antes de responder sobre info del centro  \n- **Parafrasea** la informaci√≥n obtenida  \n- **Si la base no tiene info**, admite que consultar√°s con el equipo humano\n\n### Continuidad:\n- No menciones puntuaci√≥n, stages ni clasificaciones  \n- Sigue conversando naturalmente si hacen preguntas adicionales  \n- No dejes la conversaci√≥n \"colgada\"  \n- Prioriza recopilar los 3 datos clave antes de extenderte\n\n---\n\n## üö´ NO HAGAS\n- ‚ùå Calificar leads  \n- ‚ùå Asignar puntuaciones  \n- ‚ùå Enviar links de pago directamente (excepto cuando soliciten agendar)  \n- ‚ùå Hablar de sistemas internos  \n- ‚ùå Hacer m√∫ltiples preguntas seguidas  \n- ‚ùå Inventar informaci√≥n o diagn√≥sticos m√©dicos\n\n---\n\n## üéØ OBJETIVO\n\n**FASE 1 - RECOPILACI√ìN**  \n1. ‚úÖ Problema espec√≠fico  \n2. ‚úÖ Tiempo de la molestia  \n3. ‚úÖ Intenci√≥n de compra  \n\n**FASE 2 - CONTINUIDAD**  \n- Si el usuario pregunta sobre el centro ‚Üí consulta `Supabase Vector Search`  \n- Si quiere agendar ‚Üí env√≠a enlace de reserva directa  \n\n**FASE 3 - HANDOFF**  \nLuego el **Agente de Calificaci√≥n** tomar√° el control para:\n- Calcular score  \n- Enviar ofertas o links de pago  \n- Alertar al equipo  \n\n---\n\n## üîß HERRAMIENTAS DISPONIBLES\n\n### `Supabase Vector Search`\n**Cu√°ndo usar:** Cuando el usuario pregunte sobre el centro.  \n**C√≥mo usar:** Env√≠a la query con la pregunta del usuario.  \n\nEjemplo:\n- Usuario: \"¬øCu√°nto cuesta una sesi√≥n?\"\n- Acci√≥n: Ejecutar b√∫squeda con \"precio sesi√≥n osteopat√≠a\".\n\n---\n\n## üí° EJEMPLO DE CONVERSACI√ìN COMPLETA\nUsuario: Hola\nT√∫: ¬°Hola! üëã Gracias por contactarnos. Soy tu asistente virtual. Cu√©ntame, ¬øqu√© molestia o dolor te trae hoy?\n\nUsuario: Me duele la espalda baja\nT√∫: Entiendo, dolor de espalda baja. ¬øHace cu√°nto tiempo tienes esta molestia?\n\nUsuario: Como 2 semanas\nT√∫: Gracias por la informaci√≥n. ¬øYa has considerado buscar una soluci√≥n profesional, o solo buscas informaci√≥n?\n\nUsuario: S√≠ busco soluci√≥n, cu√°nto cuesta?\nT√∫: Te comento los precios con total transparencia. Es importante que sepas que nuestros programas intensivos est√°n dise√±ados para ofrecerte un ahorro significativo comparado con si contrataras todos los servicios por separado.\n\nTe pongo primero los precios sueltos de cada servicio para que puedas ver la diferencia:\n\n**Precios de Servicios Sueltos (Sin Programa)**\n\n¬∑ Sesi√≥n de Osteopat√≠a: 80‚Ç¨\n¬∑ Sesi√≥n de Aparatolog√≠a de Fisioterapia: 35‚Ç¨\n¬∑ Sesi√≥n Inicial de Medicina Natural (Evaluaci√≥n): 110‚Ç¨\n¬∑ Seguimiento de Medicina Natural (sesi√≥n semanal): 70‚Ç¨\n\n---\n\n**El Ahorro Real con Nuestros Programas Intensivos**\n\nAhora, mira el valor y el ahorro que obtienes al contratar un programa completo:\n\n**1. Programa Intensivo de 1 Mes:**\n\n¬∑ Incluye: 5 sesiones de Osteopat√≠a + 5 Aparatolog√≠as.\n¬∑ Valor si lo pagaras suelto: (5 x 80‚Ç¨) + (5 x 35‚Ç¨) = 400‚Ç¨ + 175‚Ç¨ = 575‚Ç¨\n¬∑ Precio del Programa: 350‚Ç¨\n¬∑ ‚úÖ Tu Ahorro: 225‚Ç¨ (¬°Casi un 40% de descuento!)\n\n**2. Programa Intensivo Integral (2-4 meses) - ¬°El m√°s completo!**\n\n¬∑ Incluye: 10 sesiones de Osteopat√≠a + 10 Aparatolog√≠as + Evaluaci√≥n de Medicina Natural (110‚Ç¨) + 1 Sesi√≥n de Seguimiento (70‚Ç¨).\n¬∑ Valor si lo pagaras suelto:\n  ¬∑ Osteopat√≠a y Aparatolog√≠a: (10 x 80‚Ç¨) + (10 x 35‚Ç¨) = 800‚Ç¨ + 350‚Ç¨ = 1.150‚Ç¨\n  ¬∑ Medicina Natural: 110‚Ç¨ (inicial) + 70‚Ç¨ (seguimiento) = 180‚Ç¨\n  ¬∑ Valor Total Suelto: 1.330‚Ç¨\n¬∑ Precio del Programa: 700‚Ç¨\n¬∑ ‚úÖ Tu Ahorro: 630‚Ç¨ (¬°Casi un 50% de descuento!)\n\n¬øTe gustar√≠a agendar una evaluaci√≥n inicial para ver cu√°l se adapta mejor a ti?\n\nUsuario: S√≠, c√≥mo agendo?\nT√∫: ¬°Perfecto! Puedes reservar tu cita directamente aqu√≠:\nüëâ https://apposteopatiaatlas.viday.es/reserva\n\nUna vez confirmada tu reserva, te llegar√° un mensaje con los detalles. ¬øHay algo m√°s en lo que pueda ayudarte?\n\nUsuario: No gracias\nT√∫: ¬°Genial! Nos vemos pronto en tu cita. ¬°Hasta pronto! üëã\n\n\n---\n## üö´ L√çMITES DE CONTEXTO DEL NEGOCIO\n\n**SOLO respondes preguntas relacionadas con:**\n- Osteopat√≠a, fisioterapia y tratamientos corporales\n- Dolores musculares, articulares o posturales\n- Servicios, precios y disponibilidad de citas\n- Ubicaci√≥n, horarios y formas de contacto del consultorio\n\n**NO respondes preguntas sobre:**\n- ‚ùå Conocimientos generales (capitales, historia, geograf√≠a)\n- ‚ùå Temas acad√©micos (matem√°ticas, ciencias, literatura)\n- ‚ùå Entretenimiento (pel√≠culas, m√∫sica, deportes)\n- ‚ùå Tecnolog√≠a no relacionada con citas/pagos\n- ‚ùå Pol√≠tica, religi√≥n o temas controversiales\n- ‚ùå Cualquier tema fuera del √°mbito de salud musculoesquel√©tica\n\n### RESPUESTA EST√ÅNDAR PARA PREGUNTAS FUERA DE CONTEXTO:\n\"Disculpa, soy un asistente especializado en osteopat√≠a y solo puedo ayudarte con temas relacionados con tu salud musculoesquel√©tica, agendar citas o informaci√≥n sobre nuestros servicios. ¬øTienes alguna molestia f√≠sica que quieras consultarme? üòä\"\n\n**Mant√©n el foco:** Si el usuario insiste en temas ajenos, redirige amablemente hacia tu expertise sin ser repetitivo.\n\n## üéì RECORDATORIOS FINALES\n1. Prioriza los 3 datos clave primero  \n2. Si preguntan algo urgente, responde y luego retoma el flujo  \n3. Usa `Supabase Vector Search` para toda la info del centro  \n4. Mant√©n tono natural  \n5. Cuando alguien quiera agendar, env√≠a el enlace de reserva directa  \n6. Cierra confirmando si tienen m√°s preguntas antes de finalizar\n----\n\nLa fecha de hoy es {{ $('Code in JavaScript').item.json.fechaActual }}\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        1904,
        1376
      ],
      "id": "b27f7e9a-b7df-4f74-9e72-c6002714771b",
      "name": "AI Agent - Conversacional",
      "retryOnFail": false
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "25pwi6ochPPPTiNZ",
          "mode": "list",
          "cachedResultUrl": "/workflow/25pwi6ochPPPTiNZ",
          "cachedResultName": "AI Agent - Calificaci√≥n Leads Osteopat√≠a subworkflow"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "Chat_Id": "={{ $('Edit Fields1').item.json.chat_id }}",
            "Mensaje_actual": "={{ $('Redis2').item.json.response }}",
            "nombre": "={{ $('Execute a SQL query').item.json.nombre }}",
            "respuesta_agente": "={{ $('AI Agent - Conversacional').item.json.output }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Mensaje_actual",
              "displayName": "Mensaje_actual",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "Chat_Id",
              "displayName": "Chat_Id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "nombre",
              "displayName": "nombre",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "respuesta_agente",
              "displayName": "respuesta_agente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": true,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        2496,
        1376
      ],
      "id": "92aea6c0-1444-4214-ade0-1a8b01194866",
      "name": "Call 'WORKFLOW 2 - Agente de Calificaci√≥n'"
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolDescription": "Base de datos de un centro de osteopat√≠a que gestiona informaci√≥n del centro, servicios, terapeutas, clientes, citas, pagos y rese√±as para facilitar agendamiento y administraci√≥n autom√°tica. Permite consultas r√°pidas y seguimiento integral de pacientes y tratamientos.",
        "tableName": {
          "__rl": true,
          "value": "documents",
          "mode": "list",
          "cachedResultName": "documents"
        },
        "topK": 50,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        2144,
        1600
      ],
      "id": "1ffa937b-a12d-469e-8ec2-52cd7ede117b",
      "name": "Supabase Vector Store",
      "credentials": {}
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        2368,
        1776
      ],
      "id": "664d9957-e883-4bef-abe9-54a992f9741b",
      "name": "Embeddings OpenAI",
      "credentials": {}
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "leads",
          "mode": "list",
          "cachedResultName": "leads"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telefono": "={{ $('Edit Fields1').item.json.chat_id }}",
            "nombre": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('nombre', ``, 'string') }}"
          },
          "matchingColumns": [
            "telefono"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "nombre",
              "displayName": "nombre",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "telefono",
              "displayName": "telefono",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "mensaje_inicial",
              "displayName": "mensaje_inicial",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "clasificacion",
              "displayName": "clasificacion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "problema_principal",
              "displayName": "problema_principal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "intentos_contacto",
              "displayName": "intentos_contacto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "ultima_interaccion",
              "displayName": "ultima_interaccion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "ultimo_mensaje",
              "displayName": "ultimo_mensaje",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "necesita_llamada",
              "displayName": "necesita_llamada",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "conversation_stage",
              "displayName": "conversation_stage",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "score",
              "displayName": "score",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "urgencia",
              "displayName": "urgencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Pago_Es_Enviado",
              "displayName": "Pago_Es_Enviado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "pdf_secuencia",
              "displayName": "pdf_secuencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "fecha_ultimo_pdf",
              "displayName": "fecha_ultimo_pdf",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "respondio_pdf",
              "displayName": "respondio_pdf",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        1808,
        1968
      ],
      "id": "5508e21d-abb1-43fb-ba6f-38d6aa7d463c",
      "name": "Tool - cambiar nombre",
      "credentials": {}
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "leads",
          "mode": "list",
          "cachedResultName": "leads"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telefono": "={{ $('Edit Fields1').item.json.chat_id }}",
            "Pago_Es_Enviado": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Pago_Es_Enviado', ``, 'boolean') }}"
          },
          "matchingColumns": [
            "telefono"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "nombre",
              "displayName": "nombre",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "telefono",
              "displayName": "telefono",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "mensaje_inicial",
              "displayName": "mensaje_inicial",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "clasificacion",
              "displayName": "clasificacion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "problema_principal",
              "displayName": "problema_principal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "intentos_contacto",
              "displayName": "intentos_contacto",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "ultima_interaccion",
              "displayName": "ultima_interaccion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "ultimo_mensaje",
              "displayName": "ultimo_mensaje",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "necesita_llamada",
              "displayName": "necesita_llamada",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "conversation_stage",
              "displayName": "conversation_stage",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "score",
              "displayName": "score",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "urgencia",
              "displayName": "urgencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Pago_Es_Enviado",
              "displayName": "Pago_Es_Enviado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "pdf_secuencia",
              "displayName": "pdf_secuencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "fecha_ultimo_pdf",
              "displayName": "fecha_ultimo_pdf",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "respondio_pdf",
              "displayName": "respondio_pdf",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        2048,
        1968
      ],
      "id": "7137e5e1-0f6a-45fc-b94d-0f291f69283e",
      "name": "Tool - Update Pago_Es_Enviado",
      "credentials": {}
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Webhook').item.json.body.conversation.messages[0].attachments[0].file_type }}",
                    "rightValue": "=audio",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "be9dbcd5-0882-4ce9-9822-305865fae492"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6a0ec742-7f93-4ea1-af39-35d410da1c1a",
                    "leftValue": "={{ $('Webhook').item.json.body.conversation.messages[0].content_type }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Texto"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -1360,
        1424
      ],
      "id": "52a45d0e-543c-49be-98ac-c1270ed7e271",
      "name": "Switch"
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {
          "language": "es"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -1184,
        1184
      ],
      "id": "e9392468-8eff-427b-81a3-858301d66a6c",
      "name": "Transcribir audio",
      "credentials": {},
      "notes": "los audios estan en espa√±ol"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "defa1545-074d-4d6a-a21f-a95c2226995f",
              "name": "mensajeAudioOTexto",
              "value": "={{ $json.text || $('Edit Fields1').item.json.textoMensaje }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1104,
        1424
      ],
      "id": "c0b24134-5d52-4e04-9072-e33fb3ee74aa",
      "name": "Mapear mensaje"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Mapear mensaje').item.json.mensajeAudioOTexto }}",
                    "rightValue": "[null]",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    },
                    "id": "ea1ce058-1302-4e81-9680-f70a12960a82"
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -672,
        1408
      ],
      "id": "907c6dc8-fb87-4da2-954b-0eb0875982d0",
      "name": "Switch1"
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Edit Fields1').item.json.chat_id }}",
        "messageData": "={{ $json.mensajeAudioOTexto }}",
        "tail": true
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -464,
        1408
      ],
      "id": "dbbb10ad-8479-4b09-b727-ffbb3b04f70b",
      "name": "Redis",
      "credentials": {}
    },
    {
      "parameters": {
        "amount": 15
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -240,
        1408
      ],
      "id": "40b11bbd-7d3e-40fe-b025-fd076c932e35",
      "name": "Wait",
      "webhookId": "REDACTED"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "message",
        "key": "={{ $('Edit Fields1').item.json.chat_id }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -48,
        1408
      ],
      "id": "8be63840-b43a-4ab1-b029-eb61fdba062d",
      "name": "Redis1",
      "credentials": {}
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "8ac5729a-0f8a-4564-b4f9-dd5e1fcb4c05",
              "leftValue": "={{ $json.message.last() }}",
              "rightValue": "={{ $('Mapear mensaje').item.json.mensajeAudioOTexto }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        176,
        1408
      ],
      "id": "83d2f02b-046e-4609-955d-3e7721e925fd",
      "name": "If"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        480,
        1712
      ],
      "id": "5e5bfe3d-b822-4b2d-898d-2f105140363c",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4a46e63b-2ead-4f35-aaa2-ab4ef5fc69f2",
              "name": "response",
              "value": "={{ $('Redis1').item.json.message.join() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        464,
        1392
      ],
      "id": "8a6f7990-1a76-451d-888d-840bc46e9700",
      "name": "pregunta_usuario"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Edit Fields1').item.json.chat_id }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        624,
        1392
      ],
      "id": "60cec49a-e0b0-4dd0-baee-a7a043e380ab",
      "name": "Redis2",
      "credentials": {}
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "62cf7f96-e1f3-4350-850c-548e2291ed79",
              "leftValue": "={{ $('Switch2').item.json.chat_id }}",
              "rightValue": "+34641750559",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -896,
        1408
      ],
      "id": "5144f452-8c35-47d3-ba46-9d269e4b6136",
      "name": "If2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "04868508-eb27-4b67-9dae-c883d48466d4",
              "name": "chat_id",
              "value": "={{ $json.body.conversation.messages[0].sender.phone_number }}",
              "type": "string"
            },
            {
              "id": "4073cc89-9702-4346-b6c2-7e619ee6f55d",
              "name": "account id",
              "value": "={{ $json.body.conversation.messages[0].account_id }}",
              "type": "string"
            },
            {
              "id": "a78a3578-e487-4dc4-bdc0-6e35e3df7013",
              "name": "conversation_id",
              "value": "={{ $json.body.conversation.messages[0].conversation_id }}",
              "type": "string"
            },
            {
              "id": "005d7505-414e-42d0-ba75-390a2718043a",
              "name": "textoMensaje",
              "value": "={{ $json.body.content }}",
              "type": "string"
            },
            {
              "id": "110ef2d3-b2c5-478f-a474-819c7ad4920a",
              "name": "tipo_mensaje",
              "value": "={{ $json.body.message_type }}",
              "type": "string"
            },
            {
              "id": "c5190f93-88bd-4ecd-9896-74a4377f0b52",
              "name": "user_name",
              "value": "={{ $json.body.conversation.messages[0].sender.name }}",
              "type": "string"
            },
            {
              "id": "a17702b3-1263-4e26-8752-054e777548da",
              "name": "on_off",
              "value": "={{ $json.body.sender.custom_attributes.bot || 'on' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2480,
        1424
      ],
      "id": "b76b4ad9-c615-400e-8031-5c677d0debd5",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "jsCode": "// Obtener fecha actual en zona horaria de Madrid\nconst ahora = new Date();\n\n// Convertir a zona horaria de Madrid (Europe/Madrid)\nconst fechaMadrid = new Date(ahora.toLocaleString('en-US', { timeZone: 'Europe/Madrid' }));\n\n// Arrays en espa√±ol\nconst diasSemana = ['domingo', 'lunes', 'martes', 'mi√©rcoles', 'jueves', 'viernes', 's√°bado'];\nconst meses = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', \n               'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];\n\n// Extraer componentes de la fecha en Madrid\nconst diaSemana = diasSemana[fechaMadrid.getDay()];\nconst dia = fechaMadrid.getDate();\nconst mes = meses[fechaMadrid.getMonth()];\nconst anio = fechaMadrid.getFullYear();\nconst hora = String(fechaMadrid.getHours()).padStart(2, '0');\nconst minutos = String(fechaMadrid.getMinutes()).padStart(2, '0');\n\n// Construir la fecha en formato espa√±ol completo\nconst fechaActual = diaSemana + ' ' + dia + ' de ' + mes + ' de ' + anio + ', ' + hora + ':' + minutos;\n\n// Retornar el resultado\nreturn {\n  fechaActual: fechaActual\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        800,
        1392
      ],
      "id": "961b24e6-1a52-46e7-bcdf-5172947ff13f",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "resource": "media",
        "operation": "mediaUrlGet",
        "mediaGetId": "={{ $('Webhook').item.json.body.conversation.messages[0].attachments[0].data_url }}"
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1.1,
      "position": [
        -1568,
        1200
      ],
      "id": "837d86ba-beb7-4b4e-b4ae-edfdc9e0e314",
      "name": "Download media",
      "webhookId": "REDACTED",
      "credentials": {}
    },
    {
      "parameters": {
        "url": "={{ $json.id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1376,
        1200
      ],
      "id": "f90a234e-03a2-4026-ac98-64dabef73f0a",
      "name": "HTTP Request",
      "credentials": {}
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chatwoot",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -2720,
        1424
      ],
      "id": "ada7be8a-10a3-4465-8f0e-7a1e4b7a6292",
      "name": "Webhook",
      "webhookId": "REDACTED"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.tipo_mensaje }}",
                    "rightValue": "incoming",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "d35f3750-d2e6-4131-a0b6-92a5bf9f32da"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "incoming"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "4685a1e8-8a09-4e8a-aaa1-d1b1546f034f",
                    "leftValue": "={{ $json.tipo_mensaje }}",
                    "rightValue": "outgoing",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "outgoing"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -2160,
        1424
      ],
      "id": "ed70e82b-6b7f-4420-a529-251141215c7f",
      "name": "Switch2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://personal-chatwoot.rk9l1c.easypanel.host/api/v1/accounts/{{ $('Edit Fields1').item.json['account id'] }}/conversations/{{ $('Edit Fields1').item.json.conversation_id }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "[REDACTED]"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "={{ $json.output }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2256,
        1376
      ],
      "id": "9a325997-fb91-46df-bb9b-8051c4db2039",
      "name": "Mandar mensaje"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.on_off }}",
                    "rightValue": "on",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "a26b3b62-5c36-42b4-850a-527f69607d35"
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -1840,
        1408
      ],
      "id": "8eff4bac-fb70-4e49-b145-0971960b2bff",
      "name": "Switch3"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1824,
        1600
      ],
      "id": "e2311330-f99d-41fd-b142-4a9c9141e30b",
      "name": "OpenAI Chat Model1",
      "credentials": {}
    }
  ],
  "origin": "n8n",
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "personal-n8n.rk9l1c.easypanel.host",
            "user-agent": "rest-client/2.1.0 (linux-musl x86_64) ruby/3.4.4p34",
            "content-length": "2628",
            "accept": "application/json",
            "accept-encoding": "gzip;q=1.0,deflate;q=0.6,identity;q=0.3",
            "content-type": "application/json",
            "x-forwarded-for": "172.18.0.1",
            "x-forwarded-host": "personal-n8n.rk9l1c.easypanel.host",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "227e2e43f3cd",
            "x-real-ip": "172.18.0.1"
          },
          "params": {},
          "query": {},
          "body": {
            "account": {
              "id": 1,
              "name": "centro atlas"
            },
            "additional_attributes": {},
            "content_attributes": {},
            "content_type": "text",
            "content": "Vuelve a mandar otro mensaje urgente al personal",
            "conversation": {
              "additional_attributes": {},
              "can_reply": true,
              "channel": "Channel::Whatsapp",
              "contact_inbox": {
                "id": 3,
                "contact_id": 1,
                "inbox_id": 3,
                "source_id": "34612575083",
                "created_at": "2025-11-10T11:32:41.661Z",
                "updated_at": "2025-11-10T11:32:41.661Z",
                "hmac_verified": false,
                "pubsub_token": "ASYHQ9mHSYdbMSyZqv5dye7x"
              },
              "id": 3,
              "inbox_id": 3,
              "messages": [
                {
                  "id": 83,
                  "content": "Vuelve a mandar otro mensaje urgente al personal",
                  "account_id": 1,
                  "inbox_id": 3,
                  "conversation_id": 3,
                  "message_type": 0,
                  "created_at": 1762886744,
                  "updated_at": "2025-11-11T18:45:44.846Z",
                  "private": false,
                  "status": "sent",
                  "source_id": "wamid.HBgLMzQ2MTI1NzUwODMVAgASGCBBQ0M2NTFERDQ3MEVGRDU4NTM1QkE5M0FCOEIxMERGQgA=",
                  "content_type": "text",
                  "content_attributes": {},
                  "sender_type": "Contact",
                  "sender_id": 1,
                  "external_source_ids": {},
                  "additional_attributes": {},
                  "processed_message_content": "Vuelve a mandar otro mensaje urgente al personal",
                  "sentiment": {},
                  "conversation": {
                    "assignee_id": 1,
                    "unread_count": 2,
                    "last_activity_at": 1762886744,
                    "contact_inbox": {
                      "source_id": "34612575083"
                    }
                  },
                  "sender": {
                    "additional_attributes": {},
                    "custom_attributes": {
                      "bot": "on"
                    },
                    "email": null,
                    "id": 1,
                    "identifier": null,
                    "name": "Abde",
                    "phone_number": "+34612575083",
                    "thumbnail": "",
                    "blocked": false,
                    "type": "contact"
                  }
                }
              ],
              "labels": [],
              "meta": {
                "sender": {
                  "additional_attributes": {},
                  "custom_attributes": {
                    "bot": "on"
                  },
                  "email": null,
                  "id": 1,
                  "identifier": null,
                  "name": "Abde",
                  "phone_number": "+34612575083",
                  "thumbnail": "",
                  "blocked": false,
                  "type": "contact"
                },
                "assignee": {
                  "id": 1,
                  "name": "abde idrsisi",
                  "available_name": "abde idrsisi",
                  "avatar_url": "",
                  "type": "user",
                  "availability_status": null,
                  "thumbnail": ""
                },
                "team": null,
                "hmac_verified": false
              },
              "status": "open",
              "custom_attributes": {},
              "snoozed_until": null,
              "unread_count": 2,
              "first_reply_created_at": "2025-11-10T12:03:48.999Z",
              "priority": null,
              "waiting_since": 1762784901,
              "agent_last_seen_at": 1762816150,
              "contact_last_seen_at": 0,
              "last_activity_at": 1762886744,
              "timestamp": 1762886744,
              "created_at": 1762774361,
              "updated_at": 1762886744.8512616
            },
            "created_at": "2025-11-11T18:45:44.846Z",
            "id": 83,
            "inbox": {
              "id": 3,
              "name": "centro atlas"
            },
            "message_type": "incoming",
            "private": false,
            "sender": {
              "account": {
                "id": 1,
                "name": "centro atlas"
              },
              "additional_attributes": {},
              "avatar": "",
              "custom_attributes": {
                "bot": "on"
              },
              "email": null,
              "id": 1,
              "identifier": null,
              "name": "Abde",
              "phone_number": "+34612575083",
              "thumbnail": "",
              "blocked": false
            },
            "source_id": "wamid.HBgLMzQ2MTI1NzUwODMVAgASGCBBQ0M2NTFERDQ3MEVGRDU4NTM1QkE5M0FCOEIxMERGQgA=",
            "event": "message_created"
          },
          "webhookUrl": "https://personal-n8n.rk9l1c.easypanel.host/webhook/chatwoot",
          "executionMode": "production"
        }
      }
    ]
  },
  "repo": {
    "owner": "abdeidr",
    "name": "n8n"
  },
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "createdAt": "2025-10-09T15:12:09.102Z",
      "updatedAt": "2025-10-09T15:12:09.102Z",
      "role": "workflow:owner",
      "workflowId": "19mxUTS3ByYyzYzB",
      "projectId": "xdZYvePgLSibegaD"
    }
  ],
  "staticData": {
    "node:Schedule Cada 15 D√≠as": {
      "recurrenceRules": []
    },
    "node:Schedule Cada 24h": {
      "recurrenceRules": []
    }
  },
  "tags": [
    {
      "createdAt": "2025-11-12T22:09:07.928Z",
      "updatedAt": "2025-11-12T22:09:07.928Z",
      "id": "N5H00c4tU3rtlPMX",
      "name": "CentroAtlas"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2025-11-12T22:24:49.000Z",
  "versionId": "9a947a4d-5911-4711-a34e-129949e430f1"
}